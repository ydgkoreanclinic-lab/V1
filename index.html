<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>유동곤 국어 통합 플랫폼 v9.0 (Stable)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      corePlugins: { preflight: false },
      theme: { extend: {} }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* =========================================
       GLOBAL VARIABLES
       ========================================= */
    :root {
      /* Default (Original Olive) */
      --ink: #2d3436;
      --muted: #636e72;
      --line: #dfe6e9;
      --bg: #f1f2f6;
      --accent: #2d3436;
      --card-bg: #ffffff;
      --error-bg: #fff0f0;

      /* Signature Theme Defaults */
      --w-bg: #fdfdfb;
      --w-point: #6b705c;
      --w-point-light: rgba(107, 112, 92, 0.1);
      --w-map-bg: #f8f9fa;
      --w-input-border: #dcdcdc;
      --w-text: #2d3436;
      --w-box-bg: #fcfcfc;
      --w-err-point: #c0392b; /* Error Accent */
    }

    /* THEME PRESETS */
    [data-theme="blue"] {
      --w-bg: #f0f9ff;
      --w-point: #0284c7;
      --w-point-light: rgba(2, 132, 199, 0.1);
      --w-map-bg: #ffffff;
      --w-text: #0f172a;
      --w-box-bg: #ffffff;
      --w-err-point: #e11d48;
    }

    [data-theme="dark"] {
      --w-bg: #18181b;
      --w-point: #a78bfa;
      --w-point-light: rgba(167, 139, 250, 0.15);
      --w-map-bg: #27272a;
      --w-text: #f4f4f5;
      --w-input-border: #52525b;
      --w-box-bg: #27272a;
      --ink: #f4f4f5;
      --w-err-point: #f87171;
    }

    [data-theme="pink"] {
      --w-bg: #fff1f2;
      --w-point: #e11d48;
      --w-point-light: rgba(225, 29, 72, 0.1);
      --w-map-bg: #fff0f5;
      --w-text: #881337;
      --w-box-bg: #ffffff;
      --w-err-point: #be123c;
    }

    /* Common Styles */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: "Noto Sans KR", sans-serif;
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    .hidden { display: none !important; }
    .wrap { max-width: 800px; margin: 0 auto; padding: 20px; }
    .btn-home {
      background: transparent; border: 0; color: var(--muted);
      font-weight: 800; font-size: 13px; cursor: pointer;
      display: flex; align-items: center; gap: 5px; margin-bottom: 10px;
    }

    

    /* =========================================
       SIGNATURE UI
       ========================================= */
    #view-wrapup, #view-error { background-color: var(--w-bg); min-height: 100vh; width: 100%; max-width: 100%; padding: 0; transition: background-color 0.3s; }

    .w2-container { max-width: 700px; margin: 0 auto; padding: 40px 20px; background-color: var(--w-bg); color: var(--w-text); }
    .w2-header { margin-bottom: 35px; border-bottom: 2px solid var(--w-point); padding-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
    .w2-title-eng { font-size: 11px; font-weight: 700; color: var(--w-point); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px; display: block; }
    .w2-title-main { font-size: 26px; font-weight: 900; color: var(--w-text); letter-spacing: -1px; margin: 0; line-height: 1; }

    .w2-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; }
    .w2-info-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

    .w2-info-item { display: flex; flex-direction: column; }
    .w2-label { font-size: 10px; font-weight: 700; color: var(--muted); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
    .w2-input-line { border: 0; border-bottom: 1px solid var(--w-input-border); background: transparent; padding: 5px 0; font-size: 14px; font-weight: 600; color: var(--w-text); border-radius: 0; outline: none; font-family: inherit; transition: 0.2s; }
    .w2-input-line:focus { border-bottom-color: var(--w-point); }

    .w2-section { margin-bottom: 50px; }
    .w2-sec-header { display: flex; align-items: center; margin-bottom: 20px; justify-content: space-between; }
    .w2-sec-header-left { display: flex; align-items: center; }

    .w2-num { font-size: 15px; font-weight: 900; color: var(--w-point); margin-right: 10px; font-family: 'Georgia', serif; font-style: italic; }
    .w2-sec-title { font-size: 17px; font-weight: 800; color: var(--w-text); letter-spacing: -0.5px; }

    /* Toggle Buttons */
    .w2-toggle-group { display: flex; background: rgba(0,0,0,0.05); border-radius: 20px; padding: 2px; }
    .w2-toggle-btn { padding: 4px 12px; border-radius: 18px; font-size: 11px; font-weight: 700; cursor: pointer; border: 0; background: transparent; color: var(--muted); transition: 0.2s; }
    .w2-toggle-btn.active { background: var(--w-point); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    /* Error Color Variant for Toggle */
    .w2-toggle-btn.active.err-mode { background: var(--w-err-point); }

    /* Input Areas */
    .w2-textarea-box { width: 100%; background: var(--w-box-bg); border: 1px solid var(--w-input-border); border-radius: 8px; padding: 15px; font-size: 14px; line-height: 1.7; color: var(--w-text); resize: none; outline: none; font-family: inherit; transition: 0.2s; }
    .w2-textarea-box:focus { background: var(--w-map-bg); border-color: var(--w-point); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

    /* Map / Logic Style */
    .w2-map-container { background: var(--w-map-bg); border-radius: 12px; padding: 25px; position: relative; border: 1px solid transparent; }
    .w2-map-line { position: absolute; left: 25px; top: 35px; bottom: 35px; width: 1px; background: var(--w-input-border); }
    .w2-step-row { display: flex; margin-bottom: 25px; position: relative; padding-left: 30px; align-items: flex-start; }
    .w2-step-row:last-child { margin-bottom: 0; }
    .w2-step-dot { position: absolute; left: -5px; top: 6px; width: 11px; height: 11px; border-radius: 50%; background: var(--w-bg); border: 2px solid var(--w-point); z-index: 1; }
    .w2-step-label { min-width: 130px; font-size: 12px; font-weight: 800; color: var(--w-point); padding-top: 4px; margin-right: 10px; line-height: 1.3; }
    .w2-step-content { flex: 1; }
    .w2-input-ul { width: 100%; border: 0; background: transparent; border-bottom: 1px dashed var(--w-input-border); font-size: 13px; color: var(--w-text); padding: 3px 0; outline: none; font-family: inherit; }
    .w2-input-ul:focus { border-bottom-style: solid; border-bottom-color: var(--w-point); }
    .w2-input-ul::placeholder { color: var(--muted); opacity: 0.5; font-size: 12px; letter-spacing: -0.3px; }

    /* Promise Card */
    .w2-promise-card { background: var(--w-point); border-radius: 10px; padding: 20px; color: #fff; }
    .w2-promise-item { display: flex; align-items: center; margin-bottom: 12px; }
    .w2-promise-item:last-child { margin-bottom: 0; }
    .w2-check { width: 16px; height: 16px; border: 1.5px solid rgba(255,255,255,0.6); border-radius: 4px; margin-right: 10px; flex-shrink: 0; }
    .w2-input-trans { background: transparent; border: 0; border-bottom: 1px solid rgba(255,255,255,0.3); color: #fff; font-size: 13px; width: 100%; padding: 4px 0; outline: none; font-family: inherit; text-align: left !important; }
    .w2-input-trans::placeholder { color: rgba(255,255,255,0.5); }
    .w2-input-trans:focus { border-bottom-color: #fff; }

    /* ERROR NOTE SPECIFIC */
    .err-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .err-tag-btn {
      padding: 12px; border: 1px solid var(--w-input-border); background: var(--w-box-bg);
      border-radius: 12px; font-size: 12px; font-weight: 700; color: var(--w-text);
      cursor: pointer; text-align: center; transition: 0.2s;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
    }
    .err-tag-btn:hover { background: var(--w-point-light); border-color: var(--w-point); }
    .err-tag-btn.active { background: var(--w-point); color: #fff; border-color: var(--w-point); }
    .err-tag-btn i { width: 20px; height: 20px; margin-bottom: 2px; }

    .logic-box { border: 1px solid var(--w-input-border); border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
    .logic-header { background: var(--w-map-bg); padding: 12px 15px; font-size: 13px; font-weight: 800; color: var(--w-point); border-bottom: 1px solid var(--w-input-border); display: flex; justify-content: space-between; align-items: center; }
    .logic-body { padding: 15px; background: var(--w-box-bg); }
    .logic-split-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-start; }
    .logic-split-row:last-child { margin-bottom: 0; }
    .logic-label { min-width: 80px; font-size: 11px; font-weight: 700; color: var(--w-point); padding-top: 5px; text-align: right; margin-right: 5px; }

    /* Confusion Slider */
    .confusion-scale { display: flex; justify-content: space-between; margin-top: 5px; background: var(--w-map-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--w-input-border); }
    .confusion-item { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: var(--muted); cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .confusion-item:hover { background: rgba(0,0,0,0.05); }
    .confusion-item.active { background: var(--w-err-point); color: #fff; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    .w2-submit-btn { width: 100%; padding: 18px; background: var(--ink); color: var(--bg); border: 0; font-size: 15px; font-weight: 700; border-radius: 8px; cursor: pointer; margin-top: 40px; transition: transform 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .w2-submit-btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .w2-submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* LANDING */
    .landing-container { min-height: 100vh; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: var(--bg); }
    .landing-header { text-align: center; margin-bottom: 40px; }
    .landing-title { font-size: 26px; font-weight: 900; color: var(--ink); letter-spacing: -1px; margin: 0; line-height: 1.3; }
    .landing-sub { font-size: 12px; font-weight: 700; color: var(--muted); margin-top: 10px; letter-spacing: 1px; text-transform: uppercase; }

    .menu-grid { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 400px; }
    .menu-card { background: var(--card-bg); border: 2px solid var(--line); border-radius: 16px; padding: 25px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; text-align: left; }
    .menu-card:hover { border-color: var(--ink); transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .menu-tag { font-size: 10px; font-weight: 900; color: var(--card-bg); background: var(--ink); padding: 4px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px; }
    .menu-tag.his{background:#1d4ed8;color:#ffffff;border:1px solid #1d4ed8;}

    .menu-tag.err { background: #d63031; }
    .menu-h3 { font-size: 18px; font-weight: 900; margin: 0; color: var(--ink); }
    .menu-desc { font-size: 12px; font-weight: 500; color: var(--muted); margin-top: 5px; }
    .teacher-login-btn { margin-top: 40px; border: 0; background: transparent; color: #b2bec3; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; }

    /* ADMIN */
    .a-login { max-width: 400px; margin: 100px auto; text-align: center; background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .a-input { width: 100%; padding: 15px; margin-bottom: 15px; background: #f8f9fa; border: 1px solid #dfe6e9; border-radius: 10px; font-weight: 700; outline: none; }
    .a-btn { width: 100%; padding: 15px; background: #2d3436; color: #fff; border: 0; border-radius: 10px; font-weight: 900; cursor: pointer; }
    .a-dash { display: grid; grid-template-columns: 1fr; gap: 20px; height: calc(100vh - 100px); }
    @media(min-width: 800px) { .a-dash { grid-template-columns: 350px 1fr; } }
    .a-list { overflow-y: auto; background: var(--card-bg); border-radius: 12px; border: 1px solid #eee; padding: 10px; height: 100%; }
    .student-folder { border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; overflow: hidden; }
    .student-header { padding: 12px 15px; background: var(--bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 14px; color: var(--ink); border-bottom: 1px solid transparent; transition: 0.2s; }
    .student-header:hover { background: #f5f5f5; }
    .student-header.open { background: #f1f2f6; border-bottom-color: #eee; }
    .student-items { display: none; background: var(--card-bg); }
    .student-items.open { display: block; }
    .a-item { padding: 12px 15px; border-bottom: 1px solid #f1f2f6; cursor: pointer; transition: 0.2s; position: relative; padding-left: 20px; color: var(--ink); }
    .a-item::before { content: '•'; position: absolute; left: 8px; color: #ccc; }
    .a-item.hover { background: #f8f9fa; }
    .a-item.sel { background: var(--accent); color: #fff; border-radius: 4px; margin: 4px; }
    .a-detail { background: var(--card-bg); border-radius: 12px; border: 1px solid #eee; padding: 30px; overflow-y: auto; height: 100%; }

    /* Admin Coaching Box */
    .ai-coach-box { background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 12px; padding: 20px; margin-bottom: 30px; position: relative; }
    .ai-coach-box h4 { margin: 0 0 10px 0; color: #6c5ce7; font-size: 14px; font-weight: 800; display: flex; align-items: center; gap: 5px; }
    .ai-coach-content { font-size: 13px; color: #2d3436; line-height: 1.6; white-space: pre-wrap; }

    #view-ai-manager { max-width: 100% !important; padding: 0 !important; height: 100vh; overflow: hidden; background: #f3f4f6; }
    #toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(0,0,0,0.82); color: #fff; padding: 10px 12px; border-radius: 10px; font-size: 12px; font-weight: 700; z-index: 9999; display: none; max-width: min(520px, calc(100vw - 30px)); text-align: center; line-height: 1.4; }

    /* Modals z-index */
    #confirm-modal { z-index: 20000; }
    #prompt-modal { z-index: 10001; }
    #student-edit-modal { z-index: 10002; }
    #settings-modal { z-index: 10003; }
    #reject-modal { z-index: 20001; }
    #feedback-modal { z-index: 30000; }

    /* Report & History Accordion */
    .accordion-body { display: none; }
    .accordion-card.open .accordion-body { display: block; }
    .accordion-card .chevron { transition: transform 0.2s; }
    .accordion-card.open .chevron { transform: rotate(180deg); }
  </style>
</head>

<body>
  <div id="toast"></div>

  <!-- Custom Confirm Modal -->
  <div id="confirm-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-100 transition-all">
      <h3 class="text-lg font-bold text-gray-800 mb-2">확인</h3>
      <p id="confirm-msg" class="text-gray-600 mb-6 text-sm"></p>
      <div class="flex gap-3 justify-end">
        <button id="confirm-no" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-bold transition">취소</button>
        <button id="confirm-yes" class="px-4 py-2 bg-black hover:bg-gray-800 text-white rounded-lg text-sm font-bold transition">확인</button>
      </div>
    </div>
  </div>

  <!-- AI Rejection Modal (Guardrail) -->
  <div id="reject-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform scale-100 transition-all border-l-4 border-red-500">
      <h3 class="text-lg font-bold text-red-600 mb-2 flex items-center gap-2"><i data-lucide="alert-circle" width="20"></i> 제출 반려</h3>
      <p class="text-gray-500 text-xs font-bold mb-2">AI조교의 검수 결과, 내용이 불충분합니다.</p>
      <div id="reject-reason" class="bg-red-50 p-3 rounded-lg text-red-700 text-sm mb-6 font-medium leading-relaxed"></div>
      <div class="flex justify-end">
        <button onclick="document.getElementById('reject-modal').classList.add('hidden')" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-bold transition">내용 보완하기</button>
      </div>
    </div>
  </div>

  <!-- Prompt Editor Modal (SINGLE INSTANCE ONLY) -->
  <div id="prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[85vh]">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="font-bold text-gray-800">리포트 프롬프트 편집</h3>
        <button onclick="$('prompt-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">✖</button>
      </div>
      <div class="p-4 flex-1 overflow-y-auto space-y-4">
        <div>
          <p class="text-xs font-bold text-gray-500 mb-1">선택된 학습 기록 (자동 포함)</p>
          <div id="prompt-context-view" class="w-full h-40 p-3 border border-gray-200 bg-gray-50 rounded-lg text-xs leading-relaxed overflow-y-auto"></div>
        </div>
        <div>
          <p class="text-xs font-bold text-gray-500 mb-1">지침 및 프롬프트 (수정 가능)</p>
          <textarea id="prompt-editor" class="w-full h-48 p-3 border border-gray-300 rounded-lg text-sm font-mono leading-relaxed focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
      </div>
      <div class="p-4 border-t border-gray-100 flex justify-end gap-2">
        <button onclick="$('prompt-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold">취소</button>
        <button onclick="window.mgr.executeReport()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700">리포트 생성 시작</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal (SINGLE INSTANCE ONLY) -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
      <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">AI 시스템 설정</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">학생용 공용 API Key (Optional)</label>
          <input type="password" id="set-student-key" placeholder="AIzaSy... (학생에게 자동 적용될 키)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono">
          <p class="text-[10px] text-gray-400 mt-1">이 키를 설정하면 학생 제출 시에도 AI 피드백이 작동합니다. (Google Cloud Console에서 도메인 제한 설정 권장)</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">1. 실시간 학생 제출 검수 및 피드백 프롬프트</label>
          <textarea id="set-student-prompt" class="w-full h-32 px-3 py-2 border border-gray-300 rounded-lg text-xs font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
          <p class="text-[10px] text-gray-400 mt-1">학생이 제출할 때 즉시 분석하여 성의 없으면 차단, 통과 시 3줄 피드백 제공.</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">2. 관리자 실시간 코칭 프롬프트</label>
          <textarea id="set-admin-prompt" class="w-full h-32 px-3 py-2 border border-gray-300 rounded-lg text-xs font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
          <p class="text-[10px] text-gray-400 mt-1">관리자 대시보드에서 'AI 코칭 보기' 클릭 시 분석하는 로직.</p>
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button onclick="$('settings-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold">취소</button>
        <button onclick="window.mgr.saveSettings()" class="px-4 py-2 bg-black text-white rounded-lg text-sm font-bold hover:bg-gray-800">설정 저장</button>
      </div>
    </div>
  </div>

  <!-- Student Edit Modal (SINGLE INSTANCE ONLY) -->
  <div id="student-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
      <h3 class="font-bold text-gray-800 mb-4">학생 정보 수정</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">이름 <span class="text-red-500 text-[10px] font-normal">(수정 시 기존 데이터 연결 주의)</span></label>
          <input type="text" id="edit-std-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-gray-500 mb-1">학년</label>
          <input type="text" id="edit-std-grade" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
      </div>
      <div class="mt-6 flex justify-between gap-2">
        <button onclick="window.mgr.deleteStudentFromEdit()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-bold hover:bg-red-200">학생 삭제</button>
        <div class="flex gap-2">
          <button onclick="$('student-edit-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold">취소</button>
          <button onclick="window.mgr.saveStudentInfo()" class="px-4 py-2 bg-black text-white rounded-lg text-sm font-bold hover:bg-gray-800">저장</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all scale-100">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5"></i> 실시간 피드백 시스템</h3>
        <button onclick="window.closeFeedbackModal()" class="text-white hover:text-gray-200">✖</button>
      </div>
      <div class="p-6 space-y-4">
        <div id="fb-loading" class="hidden flex-col items-center justify-center py-6">
          <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
          <p class="text-sm font-bold text-gray-600">동곤쌤의 수제자 AI조교가 분석 및 검수 중입니다...</p>
        </div>
        <div id="fb-result" class="hidden">
          <p class="text-sm text-gray-600 font-bold mb-2">제출이 완료되었습니다</p>
          <div id="fb-content" class="text-gray-800 leading-relaxed text-sm bg-gray-50 p-4 rounded-lg border border-gray-200 whitespace-pre-wrap"></div>
        </div>
      </div>
      <div class="p-4 pt-0">
        <button onclick="window.confirmAndSavePending()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition mt-2">확인</button>
      </div>
    </div>
  </div>

  <!-- [VIEW 0] 메인 화면 -->
  <div 
  <!-- Image Viewer Modal -->
  <div id="img-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4" style="z-index:35000;">
    <div style="max-width:980px; width:100%; background:#fff; border-radius:18px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.35);">
      <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#0f172a; color:#fff;">
        <div style="font-weight:950;">첨부 이미지 보기</div>
        <button onclick="window.closeImgModal?.()" style="background:transparent; border:0; color:#fff; font-weight:950; cursor:pointer;">닫기 ✖</button>
      </div>
      <div style="padding:14px; background:#0b1220;">
        <img id="img-modal-img" src="" alt="attachment" style="width:100%; max-height:70vh; object-fit:contain; border-radius:12px; background:#000;" />
              <div id="img-modal-thumbs" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;"></div>
</div>
    </div>
  </div>

id="view-landing" class="landing-container">
    <div class="landing-header">
      <h1 class="landing-title">유동곤 국어 통합 플랫폼™ v9.0</h1>
      <div class="landing-sub">The Logic of Donggon Yoo (Stable Build)</div>
    </div>
    <div class="menu-grid">
      <div class="menu-card" onclick="window.router('wrapup')">
        <span class="menu-tag">Wrap-up</span>
        <h3 class="menu-h3">나의 사고 궤적 지도™</h3>
        <p class="menu-desc">메타인지 강화 및 복습</p>
        <i data-lucide="chevron-right" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); color:#dfe6e9;"></i>
      </div>
      <div class="menu-card" onclick="window.router('error')">
        <span class="menu-tag err">오답 클리닉</span>
        <h3 class="menu-h3">국어 공학 오답 모듈™</h3>
        <p class="menu-desc">사고 오류 진단 및 교정</p>
        <i data-lucide="chevron-right" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); color:#dfe6e9;"></i>
      </div>
    
      <div class="menu-card" onclick="window.router('history')">
        <span class="menu-tag his">History</span>
        <h3 class="menu-h3">나의 지난 기록</h3>
        <p class="menu-desc">제출 기록 및 피드백 조회</p>
        <i data-lucide="chevron-right" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); color:#dfe6e9;"></i>
      </div>
    </div>
    <button class="teacher-login-btn" onclick="window.router('admin-login')">
      <i data-lucide="lock" width="12"></i> 선생님 전용 (Admin)
    </button>
  </div>

  <!-- [VIEW H] 학생용 나의 지난 기록 -->
  <div id="view-history" class="hidden wrap" style="max-width:900px; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;"><span style="background:#1d4ed8; color:#fff; font-weight:950; font-size:11px; padding:6px 10px; border-radius:999px; letter-spacing:.02em;">HISTORY</span><h2 style="margin:0; color:#0f172a; font-size:20px; font-weight:950; line-height:1.15;">나의 지난 기록</h2></div><div style="margin-top:6px; font-size:13px; color:#334155; font-weight:800;">제출 기록 및 피드백 조회</div><div style="margin-top:2px; font-size:12px; color:#64748b;">최신순으로 정렬되며, 키워드·날짜로 빠르게 찾을 수 있습니다.</div>
      </div>
      <button onclick="window.router('landing')" style="background:#f1f5f9; border:1px solid #e2e8f0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800; font-size:12px; color:#0f172a;">홈으로</button>
    </div>

    <div style="background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); margin-bottom:14px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
        <div style="flex:1; min-width:220px;">
          <div style="font-size:11px; font-weight:900; letter-spacing:.08em; color:#64748b; margin-bottom:6px;">STUDENT NAME</div>
          <input id="h_name" type="text" class="w2-input-line" placeholder="이름을 정확히 입력" style="width:100%;" />
        </div>
        <button id="btnHistoryLoad" onclick="window.loadStudentHistory()" style="background:#111827; color:#fff; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:900; font-size:12px;">조회</button>
        <button onclick="document.getElementById('h_name').value=''; document.getElementById('historyList').innerHTML='';" style="background:transparent; border:0; color:#64748b; font-weight:900; cursor:pointer; font-size:12px;">초기화</button>
      </div>
      <div id="historyHint" style="margin-top:10px; font-size:12px; color:#1e40af; opacity:.75;">이름이 동일해야 조회됩니다. 저장된 기록이 없으면 목록이 비어 보입니다.</div>
    </div>

    <div style="background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); margin-bottom:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:950; color:#0f172a;">검색 필터</div>
        <div style="font-size:12px; color:#64748b; font-weight:800;">키워드 또는 날짜로 기록을 좁혀 보세요.</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;">
        <div style="flex:2; min-width:220px;">
          <div style="font-size:11px; font-weight:900; letter-spacing:.08em; color:#64748b; margin-bottom:6px;">KEYWORD</div>
          <input id="h_kw" type="text" class="w2-input-line" placeholder="예: 어휘 / 지시어 / 인과 / 12월 3일" style="width:100%;" oninput="window.applyHistoryFilter?.()"/>
        </div>
        <div style="min-width:160px;">
          <div style="font-size:11px; font-weight:900; letter-spacing:.08em; color:#64748b; margin-bottom:6px;">FROM</div>
          <input id="h_from" type="date" class="w2-input-line" style="width:100%;" onchange="window.applyHistoryFilter?.()"/>
        </div>
        <div style="min-width:160px;">
          <div style="font-size:11px; font-weight:900; letter-spacing:.08em; color:#64748b; margin-bottom:6px;">TO</div>
          <input id="h_to" type="date" class="w2-input-line" style="width:100%;" onchange="window.applyHistoryFilter?.()"/>
        </div>
        <button onclick="window.resetHistoryFilter?.()" style="background:#f1f5f9; border:1px solid #e2e8f0; color:#0f172a; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:900; font-size:12px;">필터 초기화</button>
      </div>
    </div>

<div id="historyList" style="background:#eff6ff; border:1px solid #93c5fd; border-radius:16px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.06);">
      <div style="padding:18px; text-align:center; color:#1e3a8a; font-weight:900;">이름을 입력하고 조회하세요.</div>
    </div>
  </div>

  <!-- [VIEW 1] 사고 궤적 지도 (Wrap-up) -->
  <div id="view-wrapup" class="hidden">
    <div class="w2-container">
      <button class="btn-home" onclick="window.router('landing')" style="margin-bottom:20px;">
        <i data-lucide="arrow-left" width="16"></i> 메인으로
      </button>

      <div class="w2-header">
        <div>
          <span class="w2-title-eng">LOGIC TRACKING MAP</span>
          <h1 class="w2-title-main">나의 사고 궤적 지도™</h1>
        </div>
      </div>

      <div class="w2-info-grid">
        <div class="w2-info-item">
          <span class="w2-label">STUDENT</span>
          <input type="text" id="w_name" class="w2-input-line" placeholder="이름 입력" oninput="window.saveDraft('wrap')" />
        </div>
        <div class="w2-info-item">
          <span class="w2-label">DATE</span>
          <div id="w_date_display" class="w2-input-line" style="border-bottom:1px solid #dcdcdc; opacity:0.8;">-</div>
        </div>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">01.</span>
            <span class="w2-sec-title">오늘 가장 집중이 필요했던 지문/개념</span>
          </div>
        </div>
        <textarea id="w_q2" class="w2-textarea-box" rows="2" placeholder="가장 많은 고민이 필요했거나 정리가 필요한 주제는?" oninput="window.saveDraft('wrap')"></textarea>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">02.</span>
            <span class="w2-sec-title">학습 내용 정밀 분석</span>
          </div>
          <div class="w2-toggle-group">
            <button class="w2-toggle-btn active" id="btn-lit" onclick="window.setSubjectType('lit'); window.saveDraft('wrap');">문학</button>
            <button class="w2-toggle-btn" id="btn-read" onclick="window.setSubjectType('read'); window.saveDraft('wrap');">독서</button>
          </div>
        </div>

        <div class="w2-map-container">
          <div class="w2-map-line"></div>

          <div class="w2-step-row">
            <div class="w2-step-dot"></div>
            <div class="w2-step-label" id="lbl-a">표현상 특징</div>
            <div class="w2-step-content">
              <input type="text" id="w_brief_a" class="w2-input-ul" placeholder="수사법, 어조, 시상 전개 등 변별력이 발생하는 지점 등" oninput="window.saveDraft('wrap')" />
            </div>
          </div>

          <div class="w2-step-row">
            <div class="w2-step-dot"></div>
            <div class="w2-step-label" id="lbl-b">내용상 특징</div>
            <div class="w2-step-content">
              <input type="text" id="w_brief_b" class="w2-input-ul" placeholder="인물 심리, 핵심 정서, 사건 전개 등 주요 판단 근거 등" oninput="window.saveDraft('wrap')" />
            </div>
          </div>

          <div class="w2-step-row">
            <div class="w2-step-dot"></div>
            <div class="w2-step-label" id="lbl-c">작품 연계/엮기</div>
            <div class="w2-step-content">
              <input type="text" id="w_brief_c" class="w2-input-ul" placeholder="공통점/차이점, <보기>와 연결되는 핵심 논리 요소 등" oninput="window.saveDraft('wrap')" />
            </div>
          </div>
        </div>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">03.</span>
            <span class="w2-sec-title">핵심 개념 및 어휘 정리</span>
          </div>
        </div>
        <textarea id="w_new_concepts" class="w2-textarea-box" rows="3" placeholder="오늘 배운 낯선 어휘나 중요 개념을 간단하게 정리해봅시다." oninput="window.saveDraft('wrap')"></textarea>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">04.</span>
            <span class="w2-sec-title">나를 지켜낼 핵심 약속</span>
          </div>
        </div>
        <div class="w2-promise-card">
          <div class="w2-promise-item">
            <div class="w2-check"></div>
            <input type="text" id="w_p1" class="w2-input-trans" placeholder="1. 시험 현장에서 반드시 상기할 핵심 원칙 1" oninput="window.saveDraft('wrap')" />
          </div>
          <div class="w2-promise-item">
            <div class="w2-check"></div>
            <input type="text" id="w_p2" class="w2-input-trans" placeholder="2. 시험 현장에서 반드시 상기할 핵심 원칙 2" oninput="window.saveDraft('wrap')" />
          </div>
          <div class="w2-promise-item">
            <div class="w2-check"></div>
            <input type="text" id="w_p3" class="w2-input-trans" placeholder="3. 시험 현장에서 반드시 상기할 핵심 원칙 3" oninput="window.saveDraft('wrap')" />
          </div>
        </div>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">05.</span>
            <span class="w2-sec-title">다음 학습을 위한 보완점 & 자가 진단</span>
          </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <textarea id="w_q5" class="w2-textarea-box" rows="4" placeholder="[보완점] 다음 학습 시 유의할 점 2가지" oninput="window.saveDraft('wrap')"></textarea>
          <textarea id="w_q6" class="w2-textarea-box" rows="4" placeholder="[자가 진단] 오늘의 학습 내용이 실전에서 어떻게 도움이 될까요?" oninput="window.saveDraft('wrap')"></textarea>
        </div>
      </div>

      
      <div class="w2-section" style="margin-top:18px;">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">+</span>
            <span class="w2-sec-title">첨부 이미지 (선택)</span>
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;">
          <label style="background:#eff6ff; border:1px solid #bfdbfe; color:#1e3a8a; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:950; font-size:12px;">
            이미지 선택
            <input id="w_attach" type="file" accept="image/*" multiple style="display:none" onchange="window.handleAttachSelect('wrapup', this.files)" />
          </label>
          <div id="w_attach_preview" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;"></div>
        </div>
        <div style="margin-top:8px; font-size:12px; color:#64748b; font-weight:800;">오답노트 필기, 사고 지도 사진 등을 첨부할 수 있습니다. (최대 5장, 장당 3MB)</div>
      </div>



      <div class="flex gap-2">
        <button id="btnSubmitWrap" class="w2-submit-btn flex-1" onclick="window.handleSubmit('wrapup')">
          <i data-lucide="send" width="16"></i> 데이터 제출 및 저장
        </button>
        <button onclick="window.clearDraft('wrap')" style="margin-top:40px; padding:0 20px; border-radius:8px; border:1px solid #ddd; background:transparent; color:var(--muted); font-size:12px; cursor:pointer;">
          초기화
        </button>
      </div>
    </div>
  </div>

  <!-- [VIEW 2] 국어 공학 오답 모듈 -->
  <div id="view-error" class="hidden">
    <div class="w2-container">
      <button class="btn-home" onclick="window.router('landing')" style="margin-bottom:20px;">
        <i data-lucide="arrow-left" width="16"></i> 메인으로
      </button>

      <div class="w2-header">
        <div>
          <span class="w2-title-eng" style="color:var(--w-err-point);">KOREAN ENGINEERING</span>
          <h1 class="w2-title-main">국어 공학 오답 모듈™</h1>
        </div>
      </div>

      <div class="w2-info-grid cols-3">
        <div class="w2-info-item">
          <span class="w2-label">STUDENT</span>
          <input type="text" id="e_name" class="w2-input-line" placeholder="이름" oninput="window.saveDraft('err')" />
        </div>
        <div class="w2-info-item" style="justify-content:flex-end;">
          <div class="w2-toggle-group" style="width:fit-content;">
            <button class="w2-toggle-btn active err-mode" id="e-btn-lit" onclick="window.setErrorType('lit')">문학</button>
            <button class="w2-toggle-btn" id="e-btn-read" onclick="window.setErrorType('read')">독서</button>
          </div>
        </div>
        <div class="w2-info-item">
          <span class="w2-label">DATE</span>
          <input type="text" id="e_date" class="w2-input-line" placeholder="YYYY.MM.DD" oninput="window.saveDraft('err')" />
        </div>
      </div>

      <div style="margin-bottom:30px;">
        <span class="w2-label">LINK (선택)</span>
        <input type="url" id="e_url" class="w2-input-line" style="width:100%;" placeholder="https://... (문제 링크 입력)" oninput="window.saveDraft('err')" />
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num" style="color:var(--w-err-point);">01.</span>
            <span class="w2-sec-title">사고 오류 유형 진단</span>
          </div>
        </div>
        <div class="err-grid" id="errorTypeGrid"></div>

        <div style="margin-top:15px; display:flex; gap:10px;">
          <div style="flex:1;">
            <span class="w2-label" style="font-size:9px;">핵심 키워드 (Concept Tag)</span>
            <input type="text" id="e_keyword" class="w2-input-ul" placeholder="ex) 역설법, 인과관계, 보기적용" style="font-size:12px;" oninput="window.saveDraft('err')" />
          </div>
          <div>
            <span class="w2-label" style="font-size:9px;">헷갈림 지수 (1~5)</span>
            <div class="confusion-scale" id="confusionGrid"></div>
          </div>
        </div>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num" style="color:var(--w-err-point);">02.</span>
            <span class="w2-sec-title">오답 브리핑</span>
          </div>
        </div>

        <div class="logic-box">
          <div class="logic-header">
            <span>A. 나의 논리 (오답 선택 이유)</span>
            <i data-lucide="x-circle" width="14" style="color:var(--w-err-point);"></i>
          </div>
          <div class="logic-body">
            <textarea id="e_reason" class="w2-input-ul" rows="2" style="border:0;" placeholder="ex) 3번 선지가 적절하다고 판단함. 왜냐하면 지문의 A내용과 같다고 생각했기 때문임." oninput="window.saveDraft('err')"></textarea>
          </div>
        </div>

        <div class="logic-box" style="border-color: var(--w-point);">
          <div class="logic-header" style="color:var(--w-point);">
            <span>B. 정답의 논리 (요건 나누기)</span>
            <i data-lucide="check-circle" width="14"></i>
          </div>
          <div class="logic-body">
            <div class="logic-split-row">
              <div class="logic-label">① 지문 근거</div>
              <input type="text" id="e_split_1" class="w2-input-ul" placeholder="ex) 지문 3문단 5번째 줄 'A는 B와 다르다'라는 진술 확인" oninput="window.saveDraft('err')" />
            </div>
            <div class="logic-split-row">
              <div class="logic-label">② 요건 나누기</div>
              <input type="text" id="e_split_2" class="w2-input-ul" placeholder="ex) 선지에서 [요건1] A와 B가 같음 + [요건2] C가 발생함 으로 나누기" oninput="window.saveDraft('err')" />
            </div>
            <div class="logic-split-row">
              <div class="logic-label">③ 최종 판단</div>
              <input type="text" id="e_split_3" class="w2-input-ul" placeholder="ex) 요건1이 지문의 내용과 정반대이므로 적절하지 않음" oninput="window.saveDraft('err')" />
            </div>
          </div>
        </div>

        <div class="logic-box">
          <div class="logic-header">
            <span>C. 미스매치 포인트 (결정적 차이)</span>
            <i data-lucide="alert-triangle" width="14"></i>
          </div>
          <div class="logic-body">
            <textarea id="e_mismatch" class="w2-input-ul" rows="1" style="border:0;" placeholder="ex) 지문의 '빨갛다'라는 정보를 '파랗다'로 잘못 읽음" oninput="window.saveDraft('err')"></textarea>
          </div>
        </div>
      </div>

      <div class="w2-section">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num" style="color:var(--w-err-point);">03.</span>
            <span class="w2-sec-title">실전 행동 강령</span>
          </div>
        </div>
        <div class="w2-promise-card" style="background:var(--w-err-point);">
          <div class="w2-promise-item">
            <div class="w2-check"></div>
            <input type="text" id="e_action" class="w2-input-trans" placeholder="ex) 선지에 지시어가 나오면 동그라미 치고 확인한다." oninput="window.saveDraft('err')" />
          </div>
        </div>
      </div>

      
      <div class="w2-section" style="margin-top:18px;">
        <div class="w2-sec-header">
          <div class="w2-sec-header-left">
            <span class="w2-num">+</span>
            <span class="w2-sec-title">첨부 이미지 (선택)</span>
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;">
          <label style="background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:950; font-size:12px;">
            이미지 선택
            <input id="e_attach" type="file" accept="image/*" multiple style="display:none" onchange="window.handleAttachSelect('error', this.files)" />
          </label>
          <div id="e_attach_preview" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;"></div>
        </div>
        <div style="margin-top:8px; font-size:12px; color:#64748b; font-weight:800;">필기/선지 표시/풀이 흔적을 첨부하면 진단 정확도가 올라갑니다. (최대 5장, 장당 3MB)</div>
      </div>



      <div class="flex gap-2">
        <button id="btnSubmitError" class="w2-submit-btn flex-1" onclick="window.handleSubmit('error')" style="background:var(--w-err-point);">
          <i data-lucide="send" width="16"></i> 오답 분석 제출
        </button>
        <button onclick="window.clearDraft('err')" style="margin-top:40px; padding:0 20px; border-radius:8px; border:1px solid #ddd; background:transparent; color:var(--muted); font-size:12px; cursor:pointer;">
          초기화
        </button>
      </div>
    </div>
  </div>

  <!-- [VIEW 3] 관리자 로그인 -->
  <div id="view-admin-login" class="hidden wrap" style="height:100vh;">
    <div class="a-login">
      <button class="btn-home" onclick="window.router('landing')" style="margin-bottom:20px;"><i data-lucide="arrow-left" width="16"></i> 나가기</button>
      <h2 style="margin-top:0; color:#2d3436;">선생님 접속</h2>
      <p style="font-size:13px; color:#666; margin-bottom:20px;">접속 코드를 입력하세요</p>
      <input type="password" id="secureApiKeyInput" class="a-input" placeholder="접속 코드" />
      <button onclick="window.handleSecureLogin()" class="a-btn">인증 및 입장</button>
    </div>
  </div>

  <!-- [VIEW 4] 관리자 대시보드 -->
  <div id="view-admin-dash" class="hidden wrap" style="max-width:1200px; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div>
        <h2 style="margin:0; color:#2d3436;">국어 학습 관제 센터</h2>
        <div style="font-size:12px; color:#666;">실시간 학생 데이터 모니터링 & AI 코칭</div>
      </div>
      <div style="display:flex; gap:10px;">
        <button onclick="window.handleLogout()" style="background:#eee; color:#666; border:0; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:12px;">키 삭제</button>
        <button onclick="window.router('ai-manager')" style="background:#6c5ce7; color:#fff; border:0; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:900; box-shadow:0 4px 10px rgba(108, 92, 231, 0.3);"><i data-lucide="sparkles" style="width:14px; margin-right:5px;"></i>IHFB 매니저</button>
        <button onclick="window.router('landing')" style="background:#2d3436; color:#fff; border:0; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">나가기</button>
      </div>
    </div>
    
    <!-- 데이터 관리 -->
    <div style="background:#ffffff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); margin-bottom:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:950; color:#111827;">데이터 관리</div>
          <div style="font-size:12px; color:#64748b;">백업 다운로드(.json) / JSON 복구 업로드</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button onclick="window.downloadBackup()" style="background:#111827; color:#fff; border:0; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900; font-size:12px;">백업 다운로드</button>
          <label style="background:#f1f5f9; border:1px solid #e2e8f0; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900; font-size:12px; color:#0f172a;">
            데이터 복구(Upload)
            <input id="backupFileInput" type="file" accept="application/json" style="display:none;" onchange="window.restoreBackupFromFile(this.files?.[0])" />
          </label>
        </div>
      </div>
      <div style="margin-top:8px; font-size:12px; color:#94a3b8;">복구는 새 문서로 추가 저장(addDoc)되며, 복구 시각이 새로 기록됩니다(원본 문서 ID·작성시각은 유지되지 않음).</div>
    </div>


    <div style="background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); margin-bottom:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:950; color:#0f172a;">제출 기록 조회</div>
          <div id="admin-total-count" style="font-size:12px; font-weight:950; color:#1e3a8a; background:#dbeafe; border:1px solid #93c5fd; padding:8px 10px; border-radius:999px;">총 0명</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input id="admin-search" type="text" placeholder="학생 이름 검색" class="w2-input-line" style="min-width:220px;" oninput="window.__adminApplyFilter?.()"/>
          <button onclick="(document.getElementById('admin-search').value=''); window.__adminApplyFilter?.();" style="background:#f1f5f9; border:1px solid #e2e8f0; color:#0f172a; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900; font-size:12px;">초기화</button>
        </div>
      </div>
    </div>

    <div class="a-dash">
      <div class="a-list" id="subList"><div style="padding:20px; text-align:center; color:#999;">데이터 대기 중...</div></div>
      <div class="a-detail" id="detailView"><div style="color:#aaa; text-align:center; padding-top:100px;">좌측 목록에서 학생을 선택하세요.</div></div>
    </div>
  </div>

  <!-- [VIEW 5] AI 매니저 (중복 모달 제거, DOM 안정화) -->
  <div id="view-ai-manager" class="hidden flex font-sans text-gray-800 bg-gray-100">
    <!-- Sidebar -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col shadow-sm z-10 h-full">
      <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
        <div><h1 class="text-xl font-extrabold text-indigo-700 flex items-center gap-2"><i data-lucide="book-open" class="w-6 h-6"></i> IHFB 매니저</h1></div>
        <button onclick="window.router('admin-dash')" class="text-xs text-gray-400 hover:text-gray-600 underline">나가기</button>
      </div>
      <div class="p-4 border-b border-gray-100 bg-white space-y-2">
        <div class="flex gap-2 mb-2">
          <input type="text" id="new-std-name" placeholder="이름" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <input type="text" id="new-std-grade" placeholder="학년" class="w-16 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <button onclick="window.mgr.addStudent()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition flex justify-center items-center gap-2">+ 학생 등록</button>
        <button onclick="window.mgr.openSettings()" class="w-full bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200 transition flex justify-center items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> 프롬프트 설정</button>
      </div>
      
          <div style="margin-top:10px; margin-bottom:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <input id="mgr-search" type="text" class="w2-input-line" placeholder="학생 이름 검색" style="width:100%;" oninput="window.mgr?.renderList?.()"/>
            </div>
            <div id="mgr-total-count" style="font-size:12px; font-weight:950; color:#0f172a; background:#f1f5f9; border:1px solid #e2e8f0; padding:10px 12px; border-radius:12px;">총 0명</div>
          </div>
<div id="mgr-student-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </div>

    <!-- Main -->
    <div class="flex-1 flex flex-col bg-gray-50 h-full">
      <div id="mgr-empty-state" class="flex-1 flex items-center justify-center">
        <div class="text-center text-gray-400">
          <i data-lucide="book-open" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
          <p class="text-lg font-medium text-gray-500">학생을 선택하여 관리를 시작하세요</p>
        </div>
      </div>

      <div id="mgr-content" class="hidden flex-col h-full">
        <div class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shadow-sm shrink-0">
          <div class="flex items-center gap-2">
            <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
              <span id="mgr-sel-name"></span>
              <span class="text-sm font-normal text-gray-500" id="mgr-sel-grade"></span>
              <button onclick="window.mgr.openEditStudent()" class="text-gray-300 hover:text-gray-600 transition"><i data-lucide="settings" class="w-4 h-4"></i></button>
            </h2>
          </div>
          <div class="flex gap-2">
            <button id="btn-report" onclick="window.mgr.openReportModal()" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 shadow-sm"><i data-lucide="file-text" class="w-4 h-4"></i> AI 리포트 생성</button>
          </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
          <div class="w-1/2 flex flex-col border-r border-gray-200 bg-white">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
              <h3 class="font-bold text-gray-700 flex items-center gap-2 text-sm"><i data-lucide="history" class="w-4 h-4"></i> 학습 기록 (선택하여 반영)</h3>
              <span class="text-xs text-gray-400">최신 기록부터</span>
            </div>
            <div id="mgr-history-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 flex flex-col"></div>
            <div class="p-4 border-t border-gray-200 bg-white">
              <div class="flex gap-2">
                <input id="mgr-memo-input" type="text" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="메모 또는 상담 내용 추가...">
                <button onclick="window.mgr.addMemo()" class="bg-gray-800 text-white px-6 py-2 rounded-lg hover:bg-gray-900 transition flex items-center gap-2"><i data-lucide="send" class="w-4 h-4"></i> 추가</button>
              </div>
            </div>
          </div>

          <div class="w-1/2 flex flex-col border-r border-gray-200 bg-white">
            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
              <h3 class="font-bold text-gray-700 mb-0 flex items-center gap-2 text-sm"><i data-lucide="check-circle" class="w-4 h-4"></i> 리포트 히스토리</h3>
              <span class="text-xs text-gray-400">최신순</span>
            </div>
            <div id="mgr-report-list" class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, serverTimestamp, deleteDoc, getDocs, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAz9xdNlxT8A9Wo3R_ERxOBXB734nwx4oI",
      authDomain: "student-d85e2.firebaseapp.com",
      projectId: "student-d85e2",
      storageBucket: "student-d85e2.firebasestorage.app",
      messagingSenderId: "765458158560",
      appId: "1:765458158560:web:5da293ec473470985e1185",
      measurementId: "G-H378SN4X7Y"
    };

    window.__firebaseReady = (async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;

        const auth = getAuth(app);
  const storage = getStorage(app);
  window.storage = storage;
  window.st = { ref, uploadBytes, getDownloadURL };
        window.auth = auth;

        // NOTE: file:// 에서 실행하면 Auth/Firestore가 브라우저 정책으로 막힐 수 있습니다.
        // 로컬 검수는 http://localhost 로 서빙 권장 (예: python -m http.server).
        if (location.protocol === 'file:') {
          console.warn("[WARN] Running on file:// may break Firebase Auth/Firestore. Use a local server (http://localhost).");
        }

        try {
          await signInAnonymously(auth);
          window.__authOk = true;
        } catch (authErr) {
          window.__authOk = false;
          console.error("Anonymous Auth Fail", authErr);
          // Auth 실패 시에도 앱은 로딩되지만, 보안 규칙에 따라 Firestore 접근이 차단될 수 있음
        }
        window.fs = { collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, serverTimestamp, deleteDoc, getDocs, where, getDoc, setDoc };
        window.__firebaseOk = true;
        return true;
      } catch (e) {
        console.error("Firebase Init Fail", e);
        window.__firebaseOk = false;
        return false;
      }
    })();
  </script>

  <script>
    // Global helper for inline event handlers
    window.$ = (id) => document.getElementById(id);

    window.addEventListener('DOMContentLoaded', async () => {
      // =========================
      // Small Utilities / State
      // =========================
      window.USER_API_KEY = null;
      window.STUDENT_API_KEY = null; // Public Key for Students

      const LS_KEY = "MILDANG_TEACHER_KEY";
      const WRAPUP_DRAFT_KEY = "MILDANG_WRAPUP_DRAFT";
      const ERR_DRAFT_KEY = "MILDANG_ERR_DRAFT";
      const SETTINGS_PATH = ['artifacts', '1:765458158560:web:5da293ec473470985e1185', 'public', 'data', 'settings', 'prompts'];

      // Default Prompts (Editable in Settings)
      const DEFAULT_STUDENT_PROMPT = `당신은 국어 교육 전문가 '유동곤 선생님'의 AI 조교입니다. 학생이 제출한 학습 내용이 너무 짧거나(10글자 미만), 성의 없거나, 의미 없는 문자열인지 판단하세요.

[규칙]
1. 성의 없음 판단 시: JSON으로 { "pass": false, "msg": "성의 없는 내용은 제출할 수 없습니다. 조금 더 구체적으로 작성해주세요." } 리턴.
2. 통과 시: 학생의 내용을 분석하여 칭찬과 함께 핵심을 찌르는 3줄 피드백을 작성하세요. JSON으로 { "pass": true, "feedback": "피드백 내용" } 리턴.
3. 피드백 말투: 친절하고 격려하는 말투.
4. 중요: 반드시 순수한 JSON 형식만 출력하세요. 마크다운 코드 블록(예: \`\`\`json)을 사용하지 마십시오.`;

      const DEFAULT_ADMIN_COACH_PROMPT = `당신은 국어 교육 전문가 '유동곤 선생님'입니다. 학생의 오답 노트 혹은 학습 기록을 보고 선생님을 위한 2가지 코칭 포인트를 제시하세요.

1. 심리 분석: 학생이 왜 이런 실수를 했는지 심리적/인지적 원인 추론 (1문장)
2. 지도 가이드: 선생님이 학생에게 해줄 수 있는 구체적인 조언이나 질문 (1문장)

출력 형식: 줄글로 자연스럽게.`;

      // Fetch Prompts from Firestore (Server Sync)
      const fetchServerPrompts = async () => {
        try {
          if (!window.db || !window.fs) return { student: DEFAULT_STUDENT_PROMPT, admin: DEFAULT_ADMIN_COACH_PROMPT };
          const snap = await window.fs.getDoc(window.fs.doc(window.db, ...SETTINGS_PATH));
          if (snap.exists()) {
            const data = snap.data();
            if (data.studentApiKey) window.STUDENT_API_KEY = data.studentApiKey;
            return data;
          }
        } catch (e) {
          console.log("Prompt fetch failed, using default", e);
        }
        return { student: DEFAULT_STUDENT_PROMPT, admin: DEFAULT_ADMIN_COACH_PROMPT };
      };

      // 1. Define UI State vars
      let selectedSubjectType = 'lit';
      let errorSubjectType = 'lit';
      let selectedConfusion = 0;
      let selectedErrors = new Set();

      const errorTypes = [
        {id:'misread', label:'지문 정보 오독', icon:'eye'},
        {id:'condition', label:'발문/보기 조건 간과', icon:'alert-triangle'},
        {id:'split', label:'선지 요건 나누기 미흡', icon:'scissors'},
        {id:'arbitrary', label:'자의적 해석(뇌피셜)', icon:'brain'},
        {id:'vocab', label:'어휘/개념 부족', icon:'book-open'},
        {id:'time', label:'시간 관리 실패', icon:'clock'}
      ];

      const getSubjectLabel = (type) => type === 'lit' ? '문학' : (type === 'read' ? '독서' : type);

      const toastEl = $('toast');
      const showToast = (msg, ms = 1800) => {
        if (!toastEl) return;
        toastEl.textContent = msg;
        toastEl.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => (toastEl.style.display = 'none'), ms);
      };

      const safeCreateIcons = () => {
        try {
          if (!window.lucide) return;
          requestAnimationFrame(() => window.lucide.createIcons());
        } catch (e) {
          console.log("Lucide icon render skipped", e);
        }
      };

      // Custom Confirm Modal Logic
      window.customConfirm = (msg) => {
        return new Promise((resolve) => {
          const modal = $('confirm-modal');
          const msgEl = $('confirm-msg');
          const btnYes = $('confirm-yes');
          const btnNo = $('confirm-no');

          if (!modal || !msgEl || !btnYes || !btnNo) return resolve(false);

          msgEl.textContent = msg;
          modal.classList.remove('hidden');

          const cleanup = () => {
            btnYes.onclick = null;
            btnNo.onclick = null;
            modal.classList.add('hidden');
          };

          btnYes.onclick = () => { cleanup(); resolve(true); };
          btnNo.onclick = () => { cleanup(); resolve(false); };
        });
      };

      // =========================
      // Firebase ready + Guard + Fetch Key
      // =========================
      const ok = await (window.__firebaseReady || Promise.resolve(false));
      if (!ok) {
        showToast("Firebase 초기화 실패: 제출/관리 기능이 제한됩니다.", 3200);
      } else {
        // Init: Fetch Prompts & Student Key
        await fetchServerPrompts();
      }

      // =========================
      // Login Logic
      // =========================
      const savedKey = localStorage.getItem(LS_KEY);
      if (savedKey && savedKey.startsWith('AIza')) window.USER_API_KEY = savedKey;

      window.handleSecureLogin = () => {
        const input = $('secureApiKeyInput');
        const val = (input?.value || '').trim();
        if (!val.startsWith('AIza')) return showToast("유효하지 않은 API Key 형식", 2500);
        localStorage.setItem(LS_KEY, val);
        window.USER_API_KEY = val;
        showToast("인증 성공");
        window.router('admin-dash');
        window.initAdminRealtimeListener?.();
        if (input) input.value = "";
      };

      window.handleLogout = async () => {
        if (await window.customConfirm("저장된 API Key를 삭제하고 로그아웃 하시겠습니까?")) {
          localStorage.removeItem(LS_KEY);
          window.USER_API_KEY = null;
          location.reload();
        }
      };

      // =========================
      // UI Render/Action functions
      // =========================
      const setSubjectType = (type) => {
        selectedSubjectType = type;
        $("btn-lit")?.classList.toggle("active", type === "lit");
        $("btn-read")?.classList.toggle("active", type === "read");

        const lblA = $("lbl-a"), lblB = $("lbl-b"), lblC = $("lbl-c");
        const inpA = $("w_brief_a"), inpB = $("w_brief_b"), inpC = $("w_brief_c");

        if (type === "read") {
          if (lblA) lblA.innerText = "지문 구조·전개";
          if (inpA) inpA.placeholder = "정의, 대조, 인과 등 선지로 바로 연결되는 문장 구조 등";
          if (lblB) lblB.innerText = "핵심 논리 설계";
          if (inpB) inpB.placeholder = "논리 구조 정립, 상관관계 분석 등 오답률이 높은 핵심 포인트 등";
          if (lblC) lblC.innerText = "고난도 선지 논리";
          if (inpC) inpC.placeholder = "추론의 근거, 자의적 해석을 유도하는 오답 구성 방식 등";
        } else {
          if (lblA) lblA.innerText = "표현상 특징";
          if (inpA) inpA.placeholder = "수사법, 어조, 시상 전개 등 변별력이 발생하는 지점 등";
          if (lblB) lblB.innerText = "내용상 특징";
          if (inpB) inpB.placeholder = "인물 심리, 핵심 정서, 사건 전개 등 주요 판단 근거 등";
          if (lblC) lblC.innerText = "작품 연계/엮기";
          if (inpC) inpC.placeholder = "공통점/차이점, <보기>와 연결되는 핵심 논리 요소 등";
        }
      };

      const setErrorType = (type) => {
        errorSubjectType = type;
        $("e-btn-lit")?.classList.toggle("active", type === "lit");
        $("e-btn-read")?.classList.toggle("active", type === "read");
        window.saveDraft("err");
      };

      const setConfusion = (level) => {
        selectedConfusion = Number(level) || 0;
        document.querySelectorAll(".confusion-item").forEach(el => {
          el.classList.toggle("active", parseInt(el.dataset.level, 10) === selectedConfusion);
        });
        window.saveDraft("err");
      };

      const renderConfusionScale = () => {
        const grid = $('confusionGrid');
        if (!grid) return;
        grid.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const div = document.createElement('div');
          div.className = `confusion-item ${selectedConfusion === i ? 'active' : ''}`;
          div.dataset.level = i;
          div.innerText = i;
          div.onclick = () => setConfusion(i);
          grid.appendChild(div);
        }
      };

      const renderErrorGrid = () => {
        const grid = $('errorTypeGrid');
        if (!grid) return;
        grid.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (const t of errorTypes) {
          const div = document.createElement('div');
          div.className = `err-tag-btn ${selectedErrors.has(t.label) ? 'active' : ''}`;
          div.innerHTML = `<i data-lucide="${t.icon}"></i><span>${t.label}</span>`;
          div.onclick = () => {
            if (selectedErrors.has(t.label)) selectedErrors.delete(t.label);
            else selectedErrors.add(t.label);
            renderErrorGrid();
            window.saveDraft('err');
          };
          frag.appendChild(div);
        }
        grid.appendChild(frag);
        setTimeout(safeCreateIcons, 0);
      };

      // Expose to window for inline calls
      window.setSubjectType = (t) => { setSubjectType(t); window.saveDraft("wrap"); };
      window.setErrorType = setErrorType;
      window.setConfusion = setConfusion;

      // =========================
      // Draft Logic
      // =========================
      const DRAFT_CFG = {
        wrap: {
          key: WRAPUP_DRAFT_KEY,
          ids: ['w_name','w_q2','w_brief_a','w_brief_b','w_brief_c','w_new_concepts','w_p1','w_p2','w_p3','w_q5','w_q6'],
          extraSave: () => ({ subjectType: selectedSubjectType }),
          extraLoad: (d) => { if (d.subjectType) setSubjectType(d.subjectType); },
          legacyMapIn: (d) => ({
            w_name: d.name ?? '', w_q2: d.q2 ?? '', w_brief_a: d.a ?? '', w_brief_b: d.b ?? '', w_brief_c: d.c ?? '',
            w_new_concepts: d.newc ?? '', w_p1: d.p1 ?? '', w_p2: d.p2 ?? '', w_p3: d.p3 ?? '', w_q5: d.q5 ?? '', w_q6: d.q6 ?? '', subjectType: d.subjectType
          })
        },
        err: {
          key: ERR_DRAFT_KEY,
          ids: ['e_name','e_date','e_keyword','e_reason','e_split_1','e_split_2','e_split_3','e_mismatch','e_action','e_url'],
          extraSave: () => ({ errorSubject: errorSubjectType, confusion: selectedConfusion, errs: Array.from(selectedErrors) }),
          extraLoad: (d) => {
            if (d.errorSubject) setErrorType(d.errorSubject);
            if (typeof d.confusion !== 'undefined') setConfusion(parseInt(d.confusion, 10) || 0);
            if (Array.isArray(d.errs)) {
              selectedErrors = new Set(d.errs);
              renderErrorGrid();
            }
          },
          legacyMapIn: (d) => ({
            e_name: d.name ?? '', e_date: d.date ?? '', e_keyword: d.keyword ?? '', e_reason: d.reason ?? '',
            e_split_1: d.s1 ?? '', e_split_2: d.s2 ?? '', e_split_3: d.s3 ?? '', e_mismatch: d.mis ?? '', e_action: d.act ?? '',
            errorSubject: d.errorSubject, confusion: d.confusion, errs: d.errs, e_url: d.url ?? ''
          })
        }
      };

      const readDraftRaw = (key) => {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
      };

      const writeDraft = (type) => {
        const cfg = DRAFT_CFG[type];
        if (!cfg) return;
        const data = {};
        for (const id of cfg.ids) {
          const el = $(id);
          data[id] = el ? (el.value ?? '') : '';
        }
        Object.assign(data, cfg.extraSave?.() || {});
        localStorage.setItem(cfg.key, JSON.stringify(data));
      };

      const applyDraft = (type) => {
        const cfg = DRAFT_CFG[type];
        if (!cfg) return;

        let d = readDraftRaw(cfg.key);
        if (!d) return;

        if (type === 'wrap' && ('name' in d || 'q2' in d)) d = cfg.legacyMapIn(d);
        if (type === 'err' && ('name' in d || 'reason' in d)) d = cfg.legacyMapIn(d);

        for (const id of cfg.ids) {
          const el = $(id);
          if (el && typeof d[id] === 'string') el.value = d[id];
        }
        cfg.extraLoad?.(d);
      };

      window.saveDraft = (type) => writeDraft(type);
      window.loadDraft = (type) => applyDraft(type);

      const _resetForm = (type) => {
        const cfg = DRAFT_CFG[type];
        if (!cfg) return;
        localStorage.removeItem(cfg.key);
        for (const id of cfg.ids) {
          const el = $(id);
          if (el) el.value = '';
        }
        if (type === 'wrap') setSubjectType('lit');
        if (type === 'err') {
          selectedErrors = new Set();
          selectedConfusion = 0;
          renderErrorGrid();
          renderConfusionScale();
          setErrorType('lit');
        }
      };

      window.clearDraft = async (type) => {
        if (!(await window.customConfirm("초기화하시겠습니까?"))) return;
        _resetForm(type);
        showToast("초기화되었습니다.");
      };

      // =========================
      // Router Logic
      // =========================
      const VIEWS = ['landing', 'history', 'wrapup', 'error', 'admin-login', 'admin-dash', 'ai-manager'];
      let currentView = 'landing';

      window.router = (viewId) => {
        if (viewId === 'admin-login' || viewId === 'admin-dash' || viewId === 'ai-manager') {
          if (window.USER_API_KEY) {
            if (viewId === 'admin-login') viewId = 'admin-dash';
            if (viewId === 'admin-dash') window.initAdminRealtimeListener?.();
          } else {
            viewId = 'admin-login';
          }
        }

        if (currentView === 'ai-manager' && viewId !== 'ai-manager') window.mgr?.stop?.();

        
        const setViewVisible = (el, on) => {
          if (!el) return;
          if (on) {
            el.classList.remove('hidden');
            el.style.display = 'block';
            el.hidden = false;
            el.removeAttribute('hidden');
            el.setAttribute('aria-hidden', 'false');
          } else {
            el.classList.add('hidden');
            el.style.display = 'none';
            el.hidden = true;
            el.setAttribute('hidden', '');
            el.setAttribute('aria-hidden', 'true');
          }
        };

        for (const id of VIEWS) {
          const el = $('view-' + id);
          setViewVisible(el, false);
        }
        const target = $('view-' + viewId);
        setViewVisible(target, true);
        currentView = viewId;


        if (viewId === 'ai-manager') window.mgr?.init?.();

        if (viewId === 'wrapup') {
          const d = readDraftRaw(WRAPUP_DRAFT_KEY);
          if (!d) _resetForm('wrap'); else window.loadDraft('wrap');
          const btn = $('btnSubmitWrap'); if (btn) { btn.disabled = false; btn.innerText = "데이터 제출 및 저장"; }
        }

        if (viewId === 'error') {
          const d = readDraftRaw(ERR_DRAFT_KEY);
          if (!d) {
            _resetForm('err');
            const eDate = $('e_date'); if (eDate) eDate.value = new Date().toLocaleDateString();
          } else {
            window.loadDraft('err');
            const eDate = $('e_date'); if (eDate && !eDate.value) eDate.value = new Date().toLocaleDateString();
          }
          renderConfusionScale();
          const btn = $('btnSubmitError'); if (btn) { btn.disabled = false; btn.innerText = "오답 분석 제출"; }
        }

        window.scrollTo(0, 0);
        safeCreateIcons();
      
        if (viewId === 'history') {
          const host = $('historyList');
          if (host) host.innerHTML = '<div style="padding:18px; text-align:center; color:#94a3b8;">이름을 입력하고 조회하세요.</div>';
          const hn = $('h_name'); if (hn) hn.value = '';
        }
};

      // =========================
      // Student History
      // =========================
      const _tsToMillis = (ts, dateStr, timeStr) => {
        try {
          if (ts && typeof ts.toMillis === 'function') return ts.toMillis();
          // Fallback: dateStr + timeStr 파싱 (로케일 의존성이 있어 보조 용도)
          if (dateStr && timeStr) {
            const dt = new Date(`${dateStr} ${timeStr}`);
            const ms = dt.getTime();
            if (!Number.isNaN(ms)) return ms;
          }
        } catch (e) {}
        return 0;
      };

      const _renderWrapupSummary = (c = {}) => {
        const brief = c.brief || {};
        const final3 = c.final3 || {};
        const imp = c.improvement || {};
        const subject = (c.subjectType === 'lit') ? '문학' : (c.subjectType === 'nonlit' ? '독서' : (c.subjectType || ''));
        return `
          <div style="display:grid; grid-template-columns:1fr; gap:8px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3;">WRAP-UP</span>
              ${subject ? `<span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#f1f5f9; color:#0f172a;">${_escapeHtml(subject)}</span>` : ``}
            </div>
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px;">
              <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">오늘 수업 핵심(3문장)</div>
              <ul style="margin:0; padding-left:16px; line-height:1.55;">
                <li>${_escapeHtml(brief.a || '(미작성)')}</li>
                <li>${_escapeHtml(brief.b || '(미작성)')}</li>
                <li>${_escapeHtml(brief.c || '(미작성)')}</li>
              </ul>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
                <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">새 개념</div>
                <div style="white-space:pre-wrap; line-height:1.55;">${_escapeHtml(c.newc || '(미작성)')}</div>
              </div>
              <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
                <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">3줄 결론</div>
                <ol style="margin:0; padding-left:16px; line-height:1.55;">
                  <li>${_escapeHtml(final3.p1 || '(미작성)')}</li>
                  <li>${_escapeHtml(final3.p2 || '(미작성)')}</li>
                  <li>${_escapeHtml(final3.p3 || '(미작성)')}</li>
                </ol>
              </div>
            </div>
            <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
              <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">개선 포인트</div>
              <div style="display:grid; grid-template-columns:1fr; gap:6px;">
                <div><span style="font-weight:900; color:#0f172a;">Q5</span> ${_escapeHtml(imp.q5 || '(미작성)')}</div>
                <div><span style="font-weight:900; color:#0f172a;">Q6</span> ${_escapeHtml(imp.q6 || '(미작성)')}</div>
              </div>
            </div>
          </div>
        `;
      };

      const _renderErrorSummary = (c = {}) => {
        const types = Array.isArray(c.errorTypes) ? c.errorTypes : [];
        const subj = (c.errorSubject === 'lit') ? '문학' : (c.errorSubject === 'nonlit' ? '독서' : (c.errorSubject || ''));
        const conf = (c.confusion === 0) ? '없음' : (c.confusion === 1 ? '조금' : (c.confusion === 2 ? '많이' : (c.confusion || '')));
        const corr = c.correctLogic || {};
        return `
          <div style="display:grid; grid-template-columns:1fr; gap:8px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#fff7ed; color:#9a3412;">오답</span>
              ${subj ? `<span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#f1f5f9; color:#0f172a;">${_escapeHtml(subj)}</span>` : ``}
              ${types.length ? `<span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#fef2f2; color:#991b1b;">${_escapeHtml(types.join(' · '))}</span>` : ``}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
                <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">키워드</div>
                <div style="white-space:pre-wrap; line-height:1.55;">${_escapeHtml(c.keyword || '(미작성)')}</div>
              </div>
              <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
                <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">헷갈림 정도</div>
                <div>${_escapeHtml(conf)}</div>
              </div>
            </div>
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px;">
              <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">내 논리</div>
              <div style="white-space:pre-wrap; line-height:1.55;">${_escapeHtml(c.myLogic || '(미작성)')}</div>
            </div>
            <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
              <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">정답 논리(요건 나누기)</div>
              <ol style="margin:0; padding-left:16px; line-height:1.55;">
                <li>${_escapeHtml(corr.split1 || '(미작성)')}</li>
                <li>${_escapeHtml(corr.split2 || '(미작성)')}</li>
                <li>${_escapeHtml(corr.split3 || '(미작성)')}</li>
              </ol>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
                <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">미스매치</div>
                <div style="white-space:pre-wrap; line-height:1.55;">${_escapeHtml(c.mismatch || '(미작성)')}</div>
              </div>
              <div style="background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px;">
                <div style="font-size:11px; font-weight:900; color:#64748b; margin-bottom:6px;">행동 교정</div>
                <div style="white-space:pre-wrap; line-height:1.55;">${_escapeHtml(c.action || '(미작성)')}</div>
              </div>
            </div>
          </div>
        `;
      };

      const _renderHistoryCard = (item) => {
        const d = item.data || {};
        const t = d.type || '';
        const isWrap = (t === 'wrapup');
        const accent = isWrap ? '#1d4ed8' : '#dc2626';
        const accentSoft = isWrap ? '#dbeafe' : '#fee2e2';
        const dateStr = d.dateStr || '';
        const timeStr = d.timeStr || '';
        const cardId = `history-card-${item.id}`;

        const header = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
            <div style="display:flex; flex-direction:column;">
              <div style="font-weight:950; color:#0f172a; font-size:14px;">${_escapeHtml(d.studentName || '')}</div>
              <div style="font-size:12px; color:#64748b;">${_escapeHtml(dateStr)} ${timeStr ? _escapeHtml(timeStr) : '<span style="opacity:.6">(시간 없음)</span>'}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <span style="font-size:11px; font-weight:900; padding:6px 10px; border-radius:999px; background:${accent}; color:#fff;">${isWrap ? 'WRAP-UP' : '오답'}</span>
              <button onclick="window.downloadHistoryCardImage?.('${cardId}')" style="background:#ffffff; border:1px solid #e2e8f0; color:#0f172a; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:900; font-size:11px;">이미지 저장</button>
            </div>
          </div>
          <div style="height:1px; background:${accentSoft}; margin-top:10px;"></div>
        `;

        const body = isWrap ? _renderWrapupSummary(d.content || {}) : _renderErrorSummary(d.content || {});

        const att = (Array.isArray(d.attachments) && d.attachments.length) ? (() => {
          const thumbs = d.attachments.slice(0, 6).map((a) => {
            const u = a?.url || '';
            const enc = encodeURIComponent(u);
            return `
              <img
                src="${_escapeHtml(u)}"
                alt="attachment"
                style="width:64px; height:64px; object-fit:cover; border-radius:12px; border:1px solid #e2e8f0; cursor:pointer;"
                onclick="window.openImgModal?.(decodeURIComponent('${enc}'))"
              />
            `;
          }).join('');

          return `
            <div style="margin-top:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <div style="font-size:11px; font-weight:950; letter-spacing:.08em; color:#64748b;">ATTACHMENTS</div>
                <div style="font-size:11px; font-weight:900; color:#334155;">총 ${d.attachments.length}장</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">${thumbs}</div>
            </div>
          `;
        })() : '';

        const ai = d.aiFeedback ? `
          <details style="margin-top:12px;">
            <summary style="cursor:pointer; font-weight:950; color:#1d4ed8; font-size:12px;">동곤쌤의 수제자 AI조교의 피드백 보기</summary>
            <div style="margin-top:8px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:12px; padding:12px; color:#0f172a; white-space:pre-wrap; line-height:1.55;">${_escapeHtml(d.aiFeedback)}</div>
          </details>
        ` : '';

        return `
          <div id="${cardId}" style="background:#fff; border:1px solid #bfdbfe; border-left:6px solid ${accent}; border-radius:16px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); margin-bottom:12px;">
            ${header}
            <div style="margin-top:10px;">${body}</div>
            ${att}
            ${ai}
          </div>
        `;
      };

      window.loadStudentHistory = async () => {
        const name = (_safeText(document.getElementById('h_name')?.value).trim());
        if (!name) return showToast("이름을 입력하세요.");
        if (!window.__firebaseOk || !window.db || !window.fs) {
          showToast("Firebase 연결이 필요합니다. 네트워크/도메인 설정을 확인하세요.", 2600);
          return;
        }

        const btn = document.getElementById('btnHistoryLoad');
        if (btn) { btn.disabled = true; btn.innerText = "조회 중..."; }

        try {
          const q = window.fs.query(
            window.fs.collection(window.db, 'submissions'),
            window.fs.where('studentName', '==', name)
          );

          const snap = await window.fs.getDocs(q);
          const rows = [];
          snap.forEach((docu) => rows.push({ id: docu.id, data: docu.data() }));

          rows.sort((a, b) => {
            const am = _tsToMillis(a.data?.timestamp, a.data?.dateStr, a.data?.timeStr);
            const bm = _tsToMillis(b.data?.timestamp, b.data?.dateStr, b.data?.timeStr);
            return bm - am;
          });

          const host = document.getElementById('historyList');
          if (!host) return;

          if (!rows.length) {
            host.innerHTML = `<div style="padding:18px; text-align:center; color:#1e3a8a; font-weight:900;">기록이 없습니다. (이름이 정확한지 확인)</div>`;
            return;
          }

          window.__historyAllRows = rows;
          window.__historyName = name;
          window.renderHistoryFiltered?.();

        } catch (e) {
          console.error(e);
          showToast("조회 실패: " + (e?.message || ''), 2400);
        } finally {
          if (btn) { btn.disabled = false; btn.innerText = "조회"; }
        }
      };



      // =========================
      // AI Logic (Gemini)
      // =========================
      const callGeminiSecure = async (text, jsonMode = true, useCustomKey = null) => {
        // Priority: Passed Key > Admin Key > Student Key
        const apiKey = useCustomKey || window.USER_API_KEY || window.STUDENT_API_KEY;

        if (!apiKey) throw new Error("API Key가 없습니다.");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
          contents: [{ parts: [{ text }] }]
        };
        if (jsonMode) payload.generationConfig = { responseMimeType: "application/json" };

        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error?.message || "API Error");

        let rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? "";
        if (!rawText) throw new Error("AI 응답이 비어 있습니다.");

        if (jsonMode) {
          rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
          return JSON.parse(rawText);
        }
        return rawText;
      };

      // =========================
      // Data Submission & AI Guardrail
      // =========================
      // =========================
      // Student Submit (Wrap-up / Error) with AI Feedback Modal + Confirm-to-Save
      // =========================
      window.__pendingSave = null;

      const _timeStr = (d = new Date()) => {
        const pad = (n) => String(n).padStart(2, '0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      };

      const _safeText = (v) => (v == null ? '' : String(v));

      const _escapeHtml = (str) => _safeText(str)
        .replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;').replaceAll("'", '&#39;');

      // =========================
      // Image Viewer Modal (Attachments)
      // =========================
      window.openImgModal = (urlOrList, listMaybe) => {
        const modal = $('img-modal');
        const img = $('img-modal-img');
        const thumbsHost = $('img-modal-thumbs');
        if (!modal || !img) return;

        const urls = Array.isArray(urlOrList) ? urlOrList : (Array.isArray(listMaybe) ? listMaybe : []);
        const first = Array.isArray(urlOrList) ? (_safeText(urlOrList[0]) || '') : (_safeText(urlOrList) || '');

        img.src = first || '';
        modal.classList.remove('hidden');

        if (thumbsHost) {
          if (urls && urls.length > 1) {
            thumbsHost.innerHTML = urls.slice(0, 24).map((u) => {
              const enc = encodeURIComponent(u || '');
              return `<img src="${_escapeHtml(u)}" style="width:64px; height:64px; object-fit:cover; border-radius:12px; border:1px solid #334155; cursor:pointer;" onclick="document.getElementById('img-modal-img').src = decodeURIComponent('${enc}')" />`;
            }).join('');
          } else {
            thumbsHost.innerHTML = '';
          }
        }
      };

      window.closeImgModal = () => {
        const modal = $('img-modal');
        const img = $('img-modal-img');
        const thumbsHost = $('img-modal-thumbs');
        if (img) img.src = '';
        if (thumbsHost) thumbsHost.innerHTML = '';
        if (modal) modal.classList.add('hidden');
      };

      // =========================
      // Card Image Download (History) - html2canvas (lazy load)
      // =========================
      window.__h2cReady = false;
      window.ensureHtml2Canvas = async () => {
        if (window.html2canvas) { window.__h2cReady = true; return true; }
        if (window.__h2cReady) return true;
        return new Promise((resolve) => {
          const s = document.createElement('script');
          s.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
          s.onload = () => { window.__h2cReady = true; resolve(true); };
          s.onerror = () => { window.__h2cReady = false; resolve(false); };
          document.head.appendChild(s);
        });
      };

      window.downloadHistoryCardImage = async (cardId) => {
        try {
          const ok = await window.ensureHtml2Canvas();
          if (!ok || !window.html2canvas) {
            showToast("이미지 저장 모듈을 불러오지 못했습니다. (도메인/CSP 확인)", 2600);
            return;
          }
          const el = document.getElementById(cardId);
          if (!el) return showToast("카드를 찾지 못했습니다.", 2000);

          const canvas = await window.html2canvas(el, { backgroundColor: "#ffffff", scale: 2 });
          const dataUrl = canvas.toDataURL("image/png");
          const a = document.createElement('a');
          a.href = dataUrl;
          a.download = (cardId || "history-card") + ".png";
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          console.error(e);
          showToast("이미지 저장 실패: " + (e?.message || ''), 2600);
        }
      };

      // =========================
      // History Filters
      // =========================
      window.__historyAllRows = [];
      window.__historyName = "";

      const _dateInputToRange = (fromStr, toStr) => {
        // fromStr / toStr: YYYY-MM-DD
        let fromMs = null;
        let toMs = null;
        try {
          if (fromStr) fromMs = new Date(fromStr + "T00:00:00").getTime();
          if (toStr) toMs = new Date(toStr + "T23:59:59").getTime();
        } catch (_) {}
        return { fromMs, toMs };
      };

      window.applyHistoryFilter = () => {
        window.renderHistoryFiltered?.();
      };

      window.resetHistoryFilter = () => {
        if ($('h_kw')) $('h_kw').value = '';
        if ($('h_from')) $('h_from').value = '';
        if ($('h_to')) $('h_to').value = '';
        window.renderHistoryFiltered?.();
      };

      window.renderHistoryFiltered = () => {
        const host = document.getElementById('historyList');
        if (!host) return;

        const rows = Array.isArray(window.__historyAllRows) ? window.__historyAllRows : [];
        const name = window.__historyName || (_safeText($('h_name')?.value).trim());

        if (!rows.length) {
          host.innerHTML = `<div style="padding:18px; text-align:center; color:#1e3a8a; font-weight:900;">기록이 없습니다. (이름이 정확한지 확인)</div>`;
          return;
        }

        const kw = _safeText($('h_kw')?.value).trim().toLowerCase();
        const { fromMs, toMs } = _dateInputToRange($('h_from')?.value, $('h_to')?.value);

        const filtered = rows.filter(r => {
          const d = r.data || {};
          const ms = _tsToMillis(d.timestamp, d.dateStr, d.timeStr);

          if (fromMs != null && ms < fromMs) return false;
          if (toMs != null && ms > toMs) return false;

          if (kw) {
            const hay = (
              (d.dateStr || '') + ' ' + (d.timeStr || '') + ' ' +
              (d.type || '') + ' ' +
              (d.aiFeedback || '') + ' ' +
              JSON.stringify(d.content || {})
            ).toLowerCase();
            if (!hay.includes(kw)) return false;
          }
          return true;
        });

        const wrapCnt = filtered.filter(r => (r.data?.type || '') === 'wrapup').length;
        const errCnt  = filtered.filter(r => (r.data?.type || '') === 'error').length;

        const totalStudents = new Set(rows.map(r => r.data?.studentName || '').filter(Boolean)).size;

        host.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; padding:12px 14px; margin-bottom:12px; background:#dbeafe; border:1px solid #93c5fd; border-radius:14px;">
            <div style="font-weight:950; color:#1e3a8a;">${_escapeHtml(name)} · ${filtered.length}건 / 전체 ${rows.length}건</div>
            <div style="font-size:12px; font-weight:950; color:#1e3a8a;">WRAP-UP ${wrapCnt} · 오답 ${errCnt} · 활동 인원 ${totalStudents}</div>
          </div>
        ` + (filtered.length ? filtered.map(_renderHistoryCard).join('') : `<div style="padding:18px; text-align:center; color:#1e3a8a; font-weight:900;">필터 결과가 없습니다.</div>`);
      };

      // =========================
      // Attachments (Upload to Firebase Storage)
      // =========================
      window.__attachState = {
        wrapup: [], // { file, url }
        error: []
      };

      const _sanitizePath = (s) => _safeText(s).replace(/[\s\/\\]+/g, "_").replace(/[^a-zA-Z0-9._-]/g, "_").slice(0, 80);

      window.handleAttachSelect = (type, fileList) => {
        const t = (type === 'wrapup') ? 'wrapup' : 'error';
        const files = Array.from(fileList || []);
        if (!files.length) return;

        const current = window.__attachState[t] || [];
        const maxFiles = 5;
        const maxEach = 3 * 1024 * 1024; // 3MB

        for (const f of files) {
          if (current.length >= maxFiles) {
            showToast("첨부는 최대 " + maxFiles + "장까지 가능합니다.", 2600);
            break;
          }
          if (!f.type || !f.type.startsWith("image/")) {
            showToast("이미지 파일만 첨부할 수 있습니다.", 2400);
            continue;
          }
          if (f.size > maxEach) {
            showToast("파일이 너무 큽니다(최대 3MB): " + f.name, 2600);
            continue;
          }
          const url = URL.createObjectURL(f);
          current.push({ file: f, url });
        }

        window.__attachState[t] = current;
        window.renderAttachPreview?.(t);
      };

      window.removeAttachFile = (type, idx) => {
        const t = (type === 'wrapup') ? 'wrapup' : 'error';
        const arr = window.__attachState[t] || [];
        const it = arr[idx];
        if (it?.url) URL.revokeObjectURL(it.url);
        arr.splice(idx, 1);
        window.__attachState[t] = arr;
        window.renderAttachPreview?.(t);
      };

      window.clearAttachments = (type) => {
        const t = (type === 'wrapup') ? 'wrapup' : (type === 'error') ? 'error' : type;
        const arr = window.__attachState[t] || [];
        arr.forEach(it => { if (it?.url) URL.revokeObjectURL(it.url); });
        window.__attachState[t] = [];
        window.renderAttachPreview?.(t);
        if (t === 'wrapup' && $('w_attach')) $('w_attach').value = '';
        if (t === 'error' && $('e_attach')) $('e_attach').value = '';
      };

      window.renderAttachPreview = (t) => {
        const host = (t === 'wrapup') ? $('w_attach_preview') : $('e_attach_preview');
        if (!host) return;
        const arr = window.__attachState[t] || [];
        if (!arr.length) {
          host.innerHTML = `<div style="font-size:12px; color:#94a3b8; font-weight:800;">첨부 없음</div>`;
          return;
        }
        host.innerHTML = arr.map((it, i) => `
          <div style="position:relative; width:76px; height:76px;">
            <img src="${it.url}" style="width:76px; height:76px; object-fit:cover; border-radius:14px; border:1px solid #e2e8f0;" />
            <button onclick="window.removeAttachFile('${t}', ${i})" style="position:absolute; top:-8px; right:-8px; width:24px; height:24px; border-radius:999px; border:1px solid #e2e8f0; background:#fff; cursor:pointer; font-weight:950;">×</button>
          </div>
        `).join('');
      };

      window.uploadAttachments = async (t, studentName) => {
        // returns [{url,name,size,type,path}]
        if (!window.storage || !window.st) return [];
        const arr = (window.__attachState[t] || []).map(x => x.file).filter(Boolean);
        if (!arr.length) return [];

        const out = [];
        const baseName = _sanitizePath(studentName || 'student');
        const stamp = Date.now();

        for (let i = 0; i < arr.length; i++) {
          const f = arr[i];
          const safeName = _sanitizePath(f.name || ('img_' + i + '.png'));
          const path = `attachments/${baseName}/${stamp}_${i}_${safeName}`;
          const r = window.st.ref(window.storage, path);
          await window.st.uploadBytes(r, f, { contentType: f.type || 'image/png' });
          const url = await window.st.getDownloadURL(r);
          out.push({ url, name: f.name || safeName, size: f.size || 0, type: f.type || 'image/png', path });
        }
        return out;
      };

      
      // =========================
      // Admin Dash: Student Name Filter + Headcount
      // =========================
      window.__adminGrouped = window.__adminGrouped || {};
      window.__adminApplyFilter = () => {
        const list = $('subList');
        if (!list) return;

        const grouped = window.__adminGrouped || {};
        const allNames = Object.keys(grouped);
        const q = _safeText($('admin-search')?.value).trim().toLowerCase();
        const names = q ? allNames.filter(n => _safeText(n).toLowerCase().includes(q)) : allNames;

        const cntEl = $('admin-total-count');
        if (cntEl) cntEl.innerText = `총 ${allNames.length}명` + (q ? ` (검색 ${names.length}명)` : '');

        if (!names.length) {
          list.innerHTML = `<div style="padding:20px; text-align:center; color:#94a3b8; font-weight:900;">검색 결과 없음</div>`;
          return;
        }

        list.innerHTML = '';

        for (const n of names) {
          const items = (grouped[n] || []).slice();
          // 최신순 정렬(안전)
          items.sort((a, b) => _tsToMillis(b.timestamp, b.dateStr, b.timeStr) - _tsToMillis(a.timestamp, a.dateStr, a.timeStr));

          const folderDiv = document.createElement('div');
          folderDiv.className = 'student-folder';

          let itemsHtml = '';
          items.forEach(item => {
            const typeLabel = item.type === 'wrapup' ? 'Wrap-up' : (item.type === 'memo' ? '메모' : '오답노트');
            const color = item.type === 'wrapup' ? '#1d4ed8' : (item.type === 'memo' ? '#0f172a' : '#dc2626');
            const dateLine = `${_escapeHtml(item.dateStr || '')} ${item.timeStr ? _escapeHtml(item.timeStr) : ''}`.trim();
            itemsHtml += `
              <div class="a-item" id="item-${item.id}">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <span style="display:inline-block; width:8px; height:8px; border-radius:999px; background:${color};"></span>
                    <div style="font-weight:900;">${typeLabel}</div>
                  </div>
                  <div style="font-size:12px; color:#94a3b8; font-weight:900;">${dateLine}</div>
                </div>
              </div>
            `;
          });

          folderDiv.innerHTML = `
                <div class="student-folder-header" onclick="window.toggleFolder(this)">
                  <div class="student-folder-name">${_escapeHtml(n)}</div>
                  <div class="student-folder-count">${items.length}건</div>
                </div>
                <div class="student-items">${itemsHtml}</div>
              `;
          list.appendChild(folderDiv);

          items.forEach(item => {
            const el = folderDiv.querySelector(`#item-${item.id}`);
            if (el) el.onclick = () => window.showSubmissionDetail(item, item.id);
          });
        }

        safeCreateIcons();
      };


      // Confirm button in feedback modal: 실제 저장 트리거
      window.confirmAndSavePending = async () => {
        try {
          if (!window.__pendingSave) {
            document.getElementById('feedback-modal')?.classList.add('hidden');
            return;
          }
          if (!window.__firebaseOk || !window.db || !window.fs) {
            showToast("Firebase 연결이 필요합니다. 네트워크/도메인 설정을 확인하세요.", 2600);
            return;
          }

          const { type, dataToSave, aiFeedback, keyUsedType } = window.__pendingSave;

          // 첨부 업로드 (선택)
          let attachments = [];
          try {
            const t = (type === 'wrapup') ? 'wrapup' : 'error';
            attachments = await window.uploadAttachments?.(t, dataToSave?.studentName || '');
          } catch (upErr) {
            console.error(upErr);
            showToast("첨부 업로드 실패: " + (upErr?.message || ''), 2600);
          }

          await window.fs.addDoc(window.fs.collection(window.db, 'submissions'), {
            ...dataToSave,
            attachments: attachments || [],
            dateStr: new Date().toLocaleDateString(),
            timeStr: _timeStr(),
            keyUsedType: keyUsedType || null, // admin|student|null (학생 화면에서는 숨김)
            aiFeedback: aiFeedback || null,   // 학생에게도 보여줄지 여부는 history 렌더링에서 제어
            timestamp: window.fs.serverTimestamp()
          });

          // 저장 후 UI 정리
          window.__pendingSave = null;
          document.getElementById('feedback-modal')?.classList.add('hidden');
          window.clearAttachments?.(type === 'wrapup' ? 'wrapup' : 'error');
          _resetForm(type === 'wrapup' ? 'wrap' : 'err');
          window.router('landing');
          showToast("저장 완료", 1600);
        } catch (e) {
          console.error(e);
          alert("저장 중 오류가 발생했습니다: " + (e?.message || ''));
        }
      };

      // Modal close: 저장 없이 종료 (의도된 동작)
      window.closeFeedbackModal = () => {
        document.getElementById('feedback-modal')?.classList.add('hidden');
        try {
          const t = window.__pendingSave?.type;
          if (t === 'wrapup') window.clearAttachments?.('wrapup');
          if (t === 'error') window.clearAttachments?.('error');
        } catch (_) {}
        window.__pendingSave = null;
      };

      window.handleSubmit = async (type) => {
        if (!window.__firebaseOk || !window.db || !window.fs) {
          showToast("Firebase 연결이 필요합니다. 네트워크/도메인 설정을 확인하세요.", 2600);
          return;
        }

        // 키 호환: v9.0 변수 + 명세 변수 동시 지원
        window.USER_KEY = window.USER_KEY || window.USER_API_KEY || null;
        window.STUDENT_KEY = window.STUDENT_KEY || window.STUDENT_API_KEY || null;
        window.USER_API_KEY = window.USER_API_KEY || window.USER_KEY || null;
        window.STUDENT_API_KEY = window.STUDENT_API_KEY || window.STUDENT_KEY || null;

        let dataToSave = {};
        let contentString = "";
        let studentName = "";

        if (type === 'wrapup') {
          const n = (_safeText($('w_name')?.value).trim());
          if (!n) return showToast("이름을 입력하세요.");
          studentName = n;
          contentString = JSON.stringify(readDraftRaw(WRAPUP_DRAFT_KEY) || {});
          dataToSave = {
            type: 'wrapup',
            studentName: n,
            content: {
              subjectType: selectedSubjectType,
              q2: $('w_q2')?.value || '',
              brief: { a: $('w_brief_a')?.value || '', b: $('w_brief_b')?.value || '', c: $('w_brief_c')?.value || '' },
              newc: $('w_new_concepts')?.value || '',
              final3: { p1: $('w_p1')?.value || '', p2: $('w_p2')?.value || '', p3: $('w_p3')?.value || '' },
              improvement: { q5: $('w_q5')?.value || '', q6: $('w_q6')?.value || '' }
            }
          };
        } else {
          const n = (_safeText($('e_name')?.value).trim());
          if (!n) return showToast("이름을 입력하세요.");
          studentName = n;
          contentString = JSON.stringify(readDraftRaw(ERR_DRAFT_KEY) || {});
          dataToSave = {
            type: 'error',
            studentName: n,
            content: {
              errorSubject: errorSubjectType,
              errorTypes: Array.from(selectedErrors),
              keyword: $('e_keyword')?.value || '',
              confusion: selectedConfusion,
              myLogic: $('e_reason')?.value || '',
              correctLogic: { split1: $('e_split_1')?.value || '', split2: $('e_split_2')?.value || '', split3: $('e_split_3')?.value || '' },
              mismatch: $('e_mismatch')?.value || '',
              action: $('e_action')?.value || '',
              url: $('e_url')?.value || ''
            }
          };
        }

        const btn = (type === 'wrapup') ? $('btnSubmitWrap') : $('btnSubmitErr');
        if (btn) { btn.disabled = true; btn.innerText = "분석 중..."; }

        // 모달 즉시 표시 (분석 중)
        $('feedback-modal').classList.remove('hidden');
        $('fb-loading').classList.remove('hidden');
        $('fb-loading').style.display = 'flex';
        $('fb-result').classList.add('hidden');
        $('fb-content').innerText = "";

        try {
          // settings 최신 로드 (학생 공용키 포함)
          const prompts = await fetchServerPrompts();
          // key 선택
          const activeKey = (window.USER_API_KEY || window.STUDENT_API_KEY || null);
          const keyUsedType = window.USER_API_KEY ? 'admin' : (window.STUDENT_API_KEY ? 'student' : null);

          let aiFeedbackText = "";

          if (activeKey) {
            // 학생/관리자 프롬프트는 기존 로직 유지(신뢰성)
            const checkPrompt = `${prompts.student}\n\n[학생 제출 내용]\n${contentString}`;
            try {
              const aiRes = await callGeminiSecure(checkPrompt, true, activeKey);

              if (aiRes && aiRes.pass === false) {
                // Reject: 명세에는 없지만, v9.0 기존 UX를 유지 (제출 최소 기준)
                window.closeFeedbackModal();
                $('reject-reason').innerText = aiRes.msg || "내용이 너무 부족합니다. 조금 더 구체적으로 작성해주세요.";
                $('reject-modal').classList.remove('hidden');
                if (btn) { btn.disabled = false; btn.innerText = "다시 제출"; }
                return;
              }
              if (aiRes && aiRes.pass === true) aiFeedbackText = _safeText(aiRes.feedback);
              else aiFeedbackText = "AI 응답 형식이 예상과 달라 기본 메시지로 대체합니다.";
            } catch (aiError) {
              console.log("AI call failed", aiError);
              aiFeedbackText = "AI 연결 상태가 원활하지 않아 피드백을 불러오지 못했습니다. (확인 버튼을 누르면 제출 내용은 저장됩니다)";
            }
          } else {
            aiFeedbackText = "AI 피드백은 선생님이 학생용 공용 키(studentApiKey)를 설정하면 자동으로 활성화됩니다.\n\n확인 버튼을 누르면 제출 내용은 저장됩니다.";
          }

          // 결과 표시
          $('fb-loading').classList.add('hidden');
          $('fb-loading').style.display = 'none';
          $('fb-result').classList.remove('hidden');
          $('fb-content').innerText = aiFeedbackText;

          // 저장 대기 상태 등록 (확인 버튼을 눌러야 저장됨)
          window.__pendingSave = { type, dataToSave, aiFeedback: aiFeedbackText, keyUsedType };

        } catch (e) {
          console.error(e);
          window.closeFeedbackModal();
          alert("제출 중 오류가 발생했습니다: " + (e?.message || ''));
        } finally {
          if (btn) { btn.disabled = false; btn.innerText = "확인 후 저장"; }
        }
      };



      // =========================
      // Legacy Admin Listener
      // =========================
      let legacyUnsub = null;

      window.deleteSubmission = async (docId) => {
        if (!docId) return;
        if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);

        if (await window.customConfirm("정말 삭제하시겠습니까?")) {
          try {
            await window.fs.deleteDoc(window.fs.doc(window.db, 'submissions', docId));
            showToast("삭제되었습니다");
            const dv = $('detailView');
            if (dv) dv.innerHTML = '<div style="color:#aaa; text-align:center; padding-top:100px;">좌측 목록에서 학생을 선택하세요.</div>';
          } catch (e) {
            console.error(e);
            showToast("삭제 실패");
          }
        }
      };

      // =========================
      // Backup & Restore (Admin)
      // =========================
      window.downloadBackup = async () => {
        try {
          if (!window.USER_API_KEY) return showToast("관리자 모드에서만 가능합니다.", 2200);
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결이 필요합니다.", 2200);

          const snap = await window.fs.getDocs(window.fs.collection(window.db, 'submissions'));
          const out = [];
          snap.forEach((d) => {
            const data = d.data();
            // admin-only meta는 포함하되, 키 값 자체는 저장하지 않음
            out.push({ id: d.id, ...data });
          });

          const blob = new Blob([JSON.stringify({ exportedAt: new Date().toISOString(), submissions: out }, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `submissions_backup_${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showToast("백업 다운로드 완료", 1600);
        } catch (e) {
          console.error(e);
          alert("백업 실패: " + (e?.message || ''));
        }
      };

      window.restoreBackupFromFile = async (file) => {
        try {
          if (!window.USER_API_KEY) return showToast("관리자 모드에서만 가능합니다.", 2200);
          if (!file) return;
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결이 필요합니다.", 2200);

          const text = await file.text();
          const parsed = JSON.parse(text);
          const list = Array.isArray(parsed?.submissions) ? parsed.submissions : (Array.isArray(parsed) ? parsed : []);
          if (!list.length) return alert("복구할 submissions 데이터가 없습니다.");

          const now = new Date();
          const pad = (n) => String(n).padStart(2, '0');
          const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
          const dateStr = now.toLocaleDateString();

          let ok = 0;
          for (const row of list) {
            try {
              const { id, timestamp, ...rest } = (row || {});
              await window.fs.addDoc(window.fs.collection(window.db, 'submissions'), {
                ...rest,
                dateStr,
                timeStr,
                timestamp: window.fs.serverTimestamp()
              });
              ok += 1;
            } catch (inner) {
              console.warn("restore row fail", inner);
            }
          }
          showToast(`복구 완료: ${ok}건`, 2000);
        } catch (e) {
          console.error(e);
          alert("복구 실패: " + (e?.message || ''));
        } finally {
          const inp = document.getElementById('backupFileInput');
          if (inp) inp.value = "";
        }
      };


      window.analyzeForAdmin = async (contentStr) => {
        const box = $('ai-coach-content');
        if (!box) return;
        box.innerHTML = "<i>AI 분석 중입니다...</i>";
        try {
          const prompts = await fetchServerPrompts();
          const fullPrompt = `${prompts.admin}\n\n[학생 기록]\n${contentStr}`;
          const res = await callGeminiSecure(fullPrompt, false);
          box.innerHTML = res;
        } catch (e) {
          box.innerHTML = "<span style='color:red'>분석 실패: API Key가 필요합니다. (선생님 로그인 확인)</span>";
        }
      };

      window.showSubmissionDetail = (data, id) => {
        const dv = $('detailView');
        if (!dv) return;

        const isWrap = data.type === 'wrapup';
        const isMemo = data.type === 'memo';
        const c = data.content || {};

        const subjectLabel = isWrap ? getSubjectLabel(c.subjectType) : (isMemo ? '' : getSubjectLabel(c.errorSubject));
        const linkBtn = c.url ? `<a href="${c.url}" target="_blank" style="display:inline-block; margin-top:5px; padding:4px 8px; background:#f1f2f6; border-radius:4px; font-size:11px; font-weight:bold; color:#0984e3; text-decoration:none;">문제 확인</a>` : '';

        let html = `
          <div class="w2-container" style="padding:0; background:transparent;">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
              <div>
                <span class="w2-title-eng" style="margin:0; font-size:10px; color:${isWrap ? 'var(--w-point)' : (isMemo ? '#f1c40f' : 'var(--w-err-point)')}">
                  ${isWrap ? 'LOGIC TRACKING MAP' : (isMemo ? 'TEACHER MEMO' : 'KOREAN ENGINEERING')}
                </span>
                <h1 class="w2-title-main" style="font-size:20px;">
                  ${data.studentName} <span style="font-size:14px; font-weight:500; color:#999;">(${data.dateStr})</span>
                </h1>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                <button onclick="window.deleteSubmission('${id}')" style="background:#ff7675; color:#fff; border:0; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold;">
                  <i data-lucide="trash-2" style="width:14px; vertical-align:middle;"></i> 삭제
                </button>
              </div>
            </div>
        `;

        html += `
          <div class="ai-coach-box">
            <h4><i data-lucide="bot" style="width:16px;"></i> AI 실시간 코칭</h4>
            <div id="ai-coach-content" class="ai-coach-content">
              <button onclick="window.analyzeForAdmin(this.closest('.w2-container').innerText)" style="background:#6c5ce7; color:white; border:0; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">
                AI 코칭 보기
              </button>
            </div>
          </div>
        `;

          // Stored AI Feedback (from student submit)
          if (data.aiFeedback) {
            html += `
              <div class="w2-section">
                <div class="w2-sec-header">
                  <div class="w2-sec-header-left">
                    <span class="w2-sec-num">AI</span><span class="w2-sec-title">학생 제출 실시간 피드백</span>
                  </div>
                </div>
                <div class="w2-textarea-box" style="height:auto; min-height:120px; white-space:pre-wrap; background:#eff6ff; border:1px solid #93c5fd;">${_escapeHtml(data.aiFeedback)}</div>
              </div>
            `;
          }


        
          if (Array.isArray(data.attachments) && data.attachments.length) {
            const thumbs = data.attachments.slice(0, 12).map((a) => {
              const u = a?.url || '';
              const enc = encodeURIComponent(u);
              return `<img src="${_escapeHtml(u)}" alt="attachment" style="width:88px; height:88px; object-fit:cover; border-radius:14px; border:1px solid #e2e8f0; cursor:pointer;" onclick="window.openImgModal?.(decodeURIComponent('${enc}'))" />`;
            }).join('');
            html += `
              <div style="margin-top:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:14px; padding:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                  <div style="font-size:12px; font-weight:950; color:#0f172a;">첨부 이미지</div>
                  <div style="font-size:12px; font-weight:950; color:#64748b;">총 ${data.attachments.length}장</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">${thumbs}</div>
              </div>
            `;
          }

if (isMemo) {
          html += `<div class="w2-section"><div class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl text-gray-800 text-sm leading-relaxed shadow-sm" style="white-space:pre-wrap;">${data.content}</div></div>`;
        } else if (isWrap) {
          html += `
            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">01.</span><span class="w2-sec-title">집중 포인트</span></div></div>
              <div class="w2-textarea-box" style="height:auto; min-height:60px; white-space:pre-wrap;">${c.q2 || ''}</div>
            </div>

            <div class="w2-section">
              <div class="w2-sec-header">
                <div class="w2-sec-header-left"><span class="w2-num">02.</span><span class="w2-sec-title">학습 내용 정밀 분석</span></div>
                <div class="w2-toggle-group"><button class="w2-toggle-btn active">${subjectLabel}</button></div>
              </div>
              <div class="w2-map-container">
                <div class="w2-map-line"></div>
                <div class="w2-step-row">
                  <div class="w2-step-dot"></div>
                  <div class="w2-step-label">${c.subjectType==='read'?'지문 구조·전개':'표현상 특징'}</div>
                  <div class="w2-step-content"><div class="w2-input-ul" style="height:auto; white-space:pre-wrap;">${c.brief?.a||''}</div></div>
                </div>
                <div class="w2-step-row">
                  <div class="w2-step-dot"></div>
                  <div class="w2-step-label">${c.subjectType==='read'?'핵심 논리 설계':'내용상 특징'}</div>
                  <div class="w2-step-content"><div class="w2-input-ul" style="height:auto; white-space:pre-wrap;">${c.brief?.b||''}</div></div>
                </div>
                <div class="w2-step-row">
                  <div class="w2-step-dot"></div>
                  <div class="w2-step-label">${c.subjectType==='read'?'고난도 선지 논리':'작품 연계/엮기'}</div>
                  <div class="w2-step-content"><div class="w2-input-ul" style="height:auto; white-space:pre-wrap;">${c.brief?.c||''}</div></div>
                </div>
              </div>
            </div>

            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">03.</span><span class="w2-sec-title">개념 및 어휘</span></div></div>
              <div class="w2-textarea-box" style="height:auto; min-height:80px; white-space:pre-wrap;">${c.newc || ''}</div>
            </div>

            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">04.</span><span class="w2-sec-title">핵심 약속</span></div></div>
              <div class="w2-promise-card">
                <div class="w2-promise-item"><div class="w2-check"></div><div class="w2-input-trans" style="height:auto; white-space:pre-wrap;">${c.final3?.p1||''}</div></div>
                <div class="w2-promise-item"><div class="w2-check"></div><div class="w2-input-trans" style="height:auto; white-space:pre-wrap;">${c.final3?.p2||''}</div></div>
                <div class="w2-promise-item"><div class="w2-check"></div><div class="w2-input-trans" style="height:auto; white-space:pre-wrap;">${c.final3?.p3||''}</div></div>
              </div>
            </div>

            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">05.</span><span class="w2-sec-title">보완점 & 자가진단</span></div></div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="w2-textarea-box" style="height:auto; min-height:100px; white-space:pre-wrap;">${c.improvement?.q5 || ''}</div>
                <div class="w2-textarea-box" style="height:auto; min-height:100px; white-space:pre-wrap;">${c.improvement?.q6 || ''}</div>
              </div>
            </div>
          `;
        } else {
          html += `
            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">01.</span><span class="w2-sec-title">진단 (${subjectLabel})</span></div></div>
              <div class="err-grid" style="margin-bottom:15px;">
                ${(c.errorTypes||[]).map(t => `<div class="err-tag-btn active" style="padding:8px;"><span style="font-size:11px;">${t}</span></div>`).join('')}
              </div>
              <div style="display:flex; gap:10px;">
                <div style="flex:1;"><span class="w2-label">키워드</span><div class="w2-input-ul" style="height:auto;">${c.keyword||''}</div></div>
                <div><span class="w2-label">헷갈림</span><div class="confusion-scale"><div class="confusion-item active" style="background:var(--w-err-point); color:#fff;">${c.confusion}</div></div></div>
              </div>
              ${linkBtn}
            </div>

            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">02.</span><span class="w2-sec-title">오답 브리핑</span></div></div>

              <div class="logic-box">
                <div class="logic-header"><span>A. 나의 논리</span><i data-lucide="x-circle" width="14" style="color:var(--w-err-point);"></i></div>
                <div class="logic-body"><div class="w2-input-ul" style="height:auto; min-height:40px; border:0; white-space:pre-wrap;">${c.myLogic||''}</div></div>
              </div>

              <div class="logic-box" style="border-color:var(--w-point);">
                <div class="logic-header" style="color:var(--w-point);"><span>B. 정답의 논리</span><i data-lucide="check-circle" width="14"></i></div>
                <div class="logic-body">
                  <div class="logic-split-row"><div class="logic-label">① 근거</div><div class="w2-input-ul" style="height:auto; white-space:pre-wrap;">${c.correctLogic?.split1||''}</div></div>
                  <div class="logic-split-row"><div class="logic-label">② 요건</div><div class="w2-input-ul" style="height:auto; white-space:pre-wrap;">${c.correctLogic?.split2||''}</div></div>
                  <div class="logic-split-row"><div class="logic-label">③ 판단</div><div class="w2-input-ul" style="height:auto; white-space:pre-wrap;">${c.correctLogic?.split3||''}</div></div>
                </div>
              </div>

              <div class="logic-box">
                <div class="logic-header"><span>C. 미스매치</span><i data-lucide="alert-triangle" width="14"></i></div>
                <div class="logic-body"><div class="w2-input-ul" style="height:auto; min-height:30px; border:0; white-space:pre-wrap;">${c.mismatch||''}</div></div>
              </div>
            </div>

            <div class="w2-section">
              <div class="w2-sec-header"><div class="w2-sec-header-left"><span class="w2-num">03.</span><span class="w2-sec-title">행동 강령</span></div></div>
              <div class="w2-promise-card" style="background:var(--w-err-point);">
                <div class="w2-promise-item"><div class="w2-check"></div><div class="w2-input-trans" style="height:auto; white-space:pre-wrap;">${c.action||''}</div></div>
              </div>
            </div>
          `;
        }

        html += `</div>`;
        dv.innerHTML = html;
        safeCreateIcons();
      };

      window.toggleFolder = (header) => {
        const items = header.nextElementSibling;
        if (!items) return;
        items.classList.toggle('open');
        header.classList.toggle('open');
      };

      window.initAdminRealtimeListener = () => {
        if (legacyUnsub) return;
        if (!window.__firebaseOk || !window.db || !window.fs) return;

        const list = $('subList');
        if (!list) return;

        legacyUnsub = window.fs.onSnapshot(
          window.fs.query(window.fs.collection(window.db, 'submissions'), window.fs.orderBy('timestamp', 'desc')),
          (snap) => {
            list.innerHTML = snap.empty ? '<div style="padding:20px; text-align:center;">데이터 없음</div>' : '';

            const grouped = {};
            snap.forEach(d => {
              const data = d.data();
              if (data.type === 'ai_report') return;
              const id = d.id;
              const n = data.studentName || '이름없음';
              if (!grouped[n]) grouped[n] = [];
              grouped[n].push({ id, ...data });
            });

            window.__adminGrouped = grouped;
            window.__adminApplyFilter?.();
safeCreateIcons();
          }
        );
      };

      // =========================
      // Manager Logic (IHFB)
      // =========================
      const APP_DOC_PATH = ['artifacts', '1:765458158560:web:5da293ec473470985e1185', 'public', 'data', 'students'];
      const REPORT_PROMPT_SUFFIX = `\n\n[원장님 보고용] 위 내용을 바탕으로 다음 JSON 형식으로 출력해:\n{"learningContent":"(ⓐ 내용)","advancedDirection":"(ⓑ 내용)"}`;

      const SYSTEM_PROMPT = `당신은 국어 교육 전문가 '밀당PT 유동곤 선생님'입니다.\n[지침]\n1. 무조건 칭찬 금지\n2. 냉철한 약점 분석\n3. 개념 질문은 '개념 부족'으로 간주\n4. 말투: 친절하지만 예리하게`;

      const DEFAULT_INSTRUCTION = `
1. 분석의 핵심 및 규칙
구체적 근거: 반드시 학생이 정리한 실제 내용을 근거로 작성하며, 추측이나 의견은 배제합니다.
개념 부족 판단: 학생이 개념에 대해 질문하거나, 선생님 질문에 답을 하더라도 근본적인 원리가 부족해 보일 경우 이를 '국어 독해력, 문학/문법 지식의 근본적 개념 부족'으로 해석하여 보완점에 반영합니다. 다만, 실질적인 근본 개념 부족으로 여겨질때만 이를 언급하고, 그렇지 않다면 근본적 개념 부족이라고 단정하지 않습니다.

2. 내용 구성 요소 (필수 포함)
수업에서 배운 내용 (Taught Content)
학생의 보완점 (Areas for Improvement)
앞으로의 학습 방향 (Future Learning Direction)
학생의 강점 및 강점으로 발전 가능한 잠재적 요소 분석

3. 어휘 및 표현 지침
선생님: '교사'나 '저' 대신 반드시 '선생님'이라는 표현을 사용합니다.
사실적 서술: 부족한 점은 미화하지 않고 사실대로 서술합니다.
현재 중심 분석: '앞으로 기대된다'와 같은 미래형 표현은 금지하며, 대화에 드러난 현 상태를 중심으로 작성합니다.

4. 형식 및 카테고리 (6줄 이내)
ⓐ 오늘의 학습 내용 및 복습 포인트: 선생님이 코멘트한 내용을 학생이 복습하기 좋게 요약 정리합니다.
ⓑ 개별 특성 및 심화 학습 방향: 학생만의 고유 특성과 보완점을 서술하되, 선생님의 직접적인 명령조가 아닌 '학생에게 이러한 능력이 필요하겠다'는 뉘앙스로 작성합니다.
      `.trim();

      let mgrUnsubscribe = null;
      let historyUnsubscribe = null;
      let reportUnsubscribe = null;
      let selectedStudentId = null;
      let selectedStudentName = "";
      let studentsData = [];
      let historyData = [];
      let reportData = [];

      const generateFullContext = (items) => {
        return items.map(item => {
          if (item.type === 'memo') return `[${item.dateStr} 선생님 메모]\n${item.content}`;

          if (item.type === 'wrapup') {
            const c = item.content;
            return `[${item.dateStr} 수업 Wrap-up (${getSubjectLabel(c.subjectType)})]\n` +
              `- 집중 포인트: ${c.q2}\n` +
              `- 특징 분석: a.${c.brief?.a||''}, b.${c.brief?.b||''}, c.${c.brief?.c||''}\n` +
              `- 개념/어휘: ${c.newc}\n` +
              `- 약속: 1.${c.final3?.p1||''}, 2.${c.final3?.p2||''}, 3.${c.final3?.p3||''}\n` +
              `- 보완/자가진단: ${c.improvement?.q5||''} / ${c.improvement?.q6||''}`;
          }

          if (item.type === 'error') {
            const c = item.content;
            return `[${item.dateStr} 오답노트 (${getSubjectLabel(c.errorSubject)})]\n` +
              `- 오류 유형: ${(c.errorTypes||[]).join(', ')}\n` +
              `- 키워드: ${c.keyword} (헷갈림: ${c.confusion})\n` +
              `- 나의 논리: ${c.myLogic}\n` +
              `- 정답 논리: 1.${c.correctLogic?.split1||''}, 2.${c.correctLogic?.split2||''}, 3.${c.correctLogic?.split3||''}\n` +
              `- 미스매치: ${c.mismatch}\n` +
              `- 행동 강령: ${c.action}`;
          }
          return '';
        }).join('\n\n--------------------------------------------------\n\n');
      };

      const generateAccordionHTML = (items) => {
        if (!items.length) return '<div class="text-center text-gray-400 py-4">선택된 항목 없음</div>';

        return items.map(item => {
          let title = '';
          let contentHtml = '';

          if (item.type === 'memo') {
            title = `<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">메모</span> ${item.dateStr}`;
            contentHtml = `<p class="whitespace-pre-wrap text-xs">${item.content}</p>`;
          } else if (item.type === 'wrapup') {
            title = `<span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded text-[10px] font-bold">Wrap-up</span> ${item.dateStr}`;
            const c = item.content;
            contentHtml = `
              <div class="space-y-2 text-xs">
                <p><strong class="text-indigo-600">집중 포인트:</strong> ${c.q2}</p>
                <div class="pl-2 border-l-2 border-indigo-50">
                  <p><strong>분석(${getSubjectLabel(c.subjectType)}):</strong></p>
                  <p>a. ${c.brief?.a||''}</p>
                  <p>b. ${c.brief?.b||''}</p>
                  <p>c. ${c.brief?.c||''}</p>
                </div>
                <p><strong class="text-indigo-600">개념/어휘:</strong> ${c.newc}</p>
                <div class="pl-2 border-l-2 border-indigo-50">
                  <p><strong>약속:</strong></p>
                  <p>1. ${c.final3?.p1||''}</p>
                  <p>2. ${c.final3?.p2||''}</p>
                  <p>3. ${c.final3?.p3||''}</p>
                </div>
                <p><strong class="text-indigo-600">보완:</strong> ${c.improvement?.q5||''}</p>
                <p><strong class="text-indigo-600">진단:</strong> ${c.improvement?.q6||''}</p>
              </div>`;
          } else {
            title = `<span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold">오답</span> ${item.dateStr}`;
            const c = item.content;
            contentHtml = `
              <div class="space-y-2 text-xs">
                <p><strong class="text-red-600">오류 유형:</strong> ${(c.errorTypes||[]).join(', ')}</p>
                <p><strong>키워드:</strong> ${c.keyword} (난이도:${c.confusion})</p>
                <p><strong class="text-red-600">나의 논리:</strong> ${c.myLogic}</p>
                <div class="pl-2 border-l-2 border-red-50">
                  <p><strong>정답 논리:</strong></p>
                  <p>① ${c.correctLogic?.split1||''}</p>
                  <p>② ${c.correctLogic?.split2||''}</p>
                  <p>③ ${c.correctLogic?.split3||''}</p>
                </div>
                <p><strong>미스매치:</strong> ${c.mismatch}</p>
                <p><strong class="text-red-600">행동 강령:</strong> ${c.action}</p>
              </div>`;
          }

          return `
            <div class="border border-gray-200 rounded-lg bg-white overflow-hidden accordion-card group">
              <div class="p-3 bg-gray-50 flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                <div class="flex items-center gap-2">${title}</div>
                <i data-lucide="chevron-down" class="chevron w-4 h-4 text-gray-400 transition-transform"></i>
              </div>
              <div class="accordion-body p-3 border-t border-gray-100 bg-white">
                ${contentHtml}
              </div>
            </div>
          `;
        }).join('');
      };

      window.mgr = {
        _reportTargetId: null,
        _reportTargetName: null,
        _currentSelectedItems: [],

        init: () => {
          if (mgrUnsubscribe) return;
          if (!window.__firebaseOk || !window.db || !window.fs) {
            showToast("Firebase 연결 실패: 매니저 기능 제한", 2600);
            return;
          }

          const colRef = window.fs.collection(window.db, ...APP_DOC_PATH);
          mgrUnsubscribe = window.fs.onSnapshot(
            window.fs.query(colRef, window.fs.orderBy('createdAt', 'desc')),
            (snap) => {
              studentsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              window.mgr.renderList();

              if (selectedStudentId) {
                const updated = studentsData.find(s => s.id === selectedStudentId);
                if (updated) {
                  if (selectedStudentName !== updated.name) {
                    selectedStudentName = updated.name;
                    window.mgr.loadHistory(selectedStudentName);
                    window.mgr.loadReports(selectedStudentName);
                  }
                  if ($('mgr-sel-name')) $('mgr-sel-name').innerText = updated.name;
                  if ($('mgr-sel-grade')) $('mgr-sel-grade').innerText = `(${updated.grade})`;
                } else {
                  selectedStudentId = null;
                  $('mgr-empty-state')?.classList.remove('hidden');
                  $('mgr-content')?.classList.add('hidden');
                }
              }
            }
          );
        },

        stop: () => {
          if (mgrUnsubscribe) mgrUnsubscribe();
          if (historyUnsubscribe) historyUnsubscribe();
          if (reportUnsubscribe) reportUnsubscribe();
          mgrUnsubscribe = null;
          historyUnsubscribe = null;
          reportUnsubscribe = null;
          selectedStudentId = null;
          selectedStudentName = "";
          studentsData = [];
          historyData = [];
          reportData = [];
          window.mgr._reportTargetId = null;
          window.mgr._reportTargetName = null;
          window.mgr._currentSelectedItems = [];
        },

        renderList: () => {
          const listEl = $('mgr-student-list');
          if (!listEl) return;


          const q = (_safeText($('mgr-search')?.value).trim().toLowerCase());
          const filtered = q ? studentsData.filter(s => _safeText(s.name).toLowerCase().includes(q)) : studentsData;
          const totalEl = $('mgr-total-count');
          if (totalEl) totalEl.innerText = `총 ${studentsData.length}명` + (q ? ` (검색 ${filtered.length}명)` : '');
          if (!filtered.length) {
            listEl.innerHTML = '<div class="text-center text-gray-400 py-10 text-sm">학생 없음</div>';
            safeCreateIcons();
            return;
          }

          const frag = document.createDocumentFragment();
          for (const s of filtered) {
            const div = document.createElement('div');
            const isSel = selectedStudentId === s.id;
            const initial = (s.name || '?')[0];
            div.className = `p-3 rounded-xl cursor-pointer transition flex justify-between items-center ${isSel ? 'bg-indigo-50 border-indigo-200 border shadow-sm' : 'hover:bg-gray-50 border border-transparent'}`;
            div.innerHTML =
              `<div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold ${isSel ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-200 text-gray-600'}">${initial}</div>
                <div>
                  <div class="font-semibold text-gray-800">${s.name}</div>
                  <div class="text-xs text-gray-500">${s.grade || '-'}</div>
                </div>
              </div>`;
            div.onclick = () => window.mgr.selectStudent(s.id);
            frag.appendChild(div);
          }
          listEl.replaceChildren(frag);
          safeCreateIcons();
        },

        addStudent: async () => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);
          const n = ($('new-std-name')?.value || '').trim();
          const g = ($('new-std-grade')?.value || '').trim();
          if (!n) return showToast("이름 필수");
          await window.fs.addDoc(window.fs.collection(window.db, ...APP_DOC_PATH), {
            name: n, grade: g, chatLog: "", report: null, createdAt: window.fs.serverTimestamp()
          });
          if ($('new-std-name')) $('new-std-name').value = '';
          if ($('new-std-grade')) $('new-std-grade').value = '';
        },

        openAttachments: (historyId) => {
          const it = historyData.find(x => x.id === historyId);
          const urls = (it?.attachments || []).map(a => a?.url).filter(Boolean);
          if (!urls.length) return showToast("첨부 이미지가 없습니다.", 2200);
          window.openImgModal?.(urls);
        },

        openSettings: async () => {
          const prompts = await fetchServerPrompts();
          $('set-student-prompt').value = prompts.student;
          $('set-admin-prompt').value = prompts.admin;
          $('set-student-key').value = prompts.studentApiKey || "";
          $('settings-modal').classList.remove('hidden');
        },

        saveSettings: async () => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);
          const newPrompts = {
            student: $('set-student-prompt').value,
            admin: $('set-admin-prompt').value,
            studentApiKey: $('set-student-key').value
          };
          await window.fs.setDoc(window.fs.doc(window.db, ...SETTINGS_PATH), newPrompts);
          $('settings-modal').classList.add('hidden');
          showToast("설정 저장됨");
          // Refresh global key
          window.STUDENT_API_KEY = newPrompts.studentApiKey;
        },

        deleteStudentFromEdit: async () => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);
          if (!selectedStudentId) return;
          $('student-edit-modal').classList.add('hidden');
          setTimeout(async () => {
            if (await window.customConfirm('정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
              await window.fs.deleteDoc(window.fs.doc(window.db, ...APP_DOC_PATH, selectedStudentId));
              showToast("학생 삭제 완료");
            } else {
              $('student-edit-modal').classList.remove('hidden');
            }
          }, 100);
        },

        deleteSubmissionItem: async (id) => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);
          if (await window.customConfirm('이 항목을 삭제하시겠습니까?')) {
            const el = document.querySelector(`[data-id="${id}"]`)?.closest('.group');
            if (el) el.remove();
            await window.fs.deleteDoc(window.fs.doc(window.db, 'submissions', id));
            showToast("삭제되었습니다.");
          }
        },

        // ===== Load Learning History (Oldest -> Newest) =====
        loadHistory: (studentName) => {
          if (!window.__firebaseOk || !window.db || !window.fs) return;
          if (historyUnsubscribe) historyUnsubscribe();
          const subRef = window.fs.collection(window.db, 'submissions');
          const q = window.fs.query(subRef, window.fs.where('studentName', '==', studentName));

          historyUnsubscribe = window.fs.onSnapshot(q, (snap) => {
            historyData = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .filter(d => d.type !== 'ai_report')
              .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            window.mgr.renderHistory();
          });
        },

        renderHistory: () => {
          const list = $('mgr-history-list');
          if (!list) return;
          list.innerHTML = '';

          if (historyData.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-10 text-xs">기록이 없습니다.</div>';
            return;
          }

          const frag = document.createDocumentFragment();
          historyData.forEach(item => {
            const div = document.createElement('div');
            const isMemo = item.type === 'memo';
            const isWrap = item.type === 'wrapup';

            let typeBadge = '';
            let summary = '';
            let borderColor = 'border-gray-200';
            let bgColor = 'bg-white';
            let detailedContent = '';

            if (isMemo) {
              typeBadge = `<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">메모</span>`;
              summary = item.content || '';
              borderColor = 'border-yellow-200';
              bgColor = 'bg-yellow-50';
              detailedContent = `<p class="whitespace-pre-wrap">${item.content}</p>`;
            } else if (isWrap) {
              typeBadge = `<span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded text-[10px] font-bold">Wrap-up</span>`;
              borderColor = 'border-indigo-100';
              summary = `<span class="text-xs text-gray-500">집중 포인트:</span> ${item.content?.q2 || '내용 없음'}`;

              const c = item.content;
              detailedContent = `
                <div class="space-y-2">
                  <p class="font-bold text-indigo-600">집중 포인트</p><p>${c.q2}</p>
                  <hr class="border-indigo-100 my-2">
                  <p class="font-bold text-indigo-600">분석 (${getSubjectLabel(c.subjectType)})</p>
                  <ul class="list-disc list-inside pl-1 text-xs text-gray-600">
                    <li>a. ${c.brief?.a||''}</li><li>b. ${c.brief?.b||''}</li><li>c. ${c.brief?.c||''}</li>
                  </ul>
                  <p class="mt-2 font-bold text-indigo-600">개념/어휘</p><p>${c.newc}</p>
                  <p class="mt-2 font-bold text-indigo-600">약속</p>
                  <p>1. ${c.final3?.p1||''}<br>2. ${c.final3?.p2||''}<br>3. ${c.final3?.p3||''}</p>
                  <p class="mt-2 font-bold text-indigo-600">보완점 / 자가진단</p>
                  <p>${c.improvement?.q5||''} / ${c.improvement?.q6||''}</p>
                </div>
              `;
            } else {
              typeBadge = `<span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold">오답노트</span>`;
              borderColor = 'border-red-100';
              const c = item.content;
              const errs = (c.errorTypes || []).join(', ');
              summary = `<span class="text-xs text-gray-500">유형:</span> ${errs || '미지정'} / <span class="text-xs text-gray-500">논리:</span> ${c.myLogic || ''}`;

              const linkBtn = c.url ? `<a href="${c.url}" target="_blank" class="block mt-2 text-blue-500 underline">문제 확인</a>` : '';

              detailedContent = `
                <div class="space-y-2">
                  <p class="font-bold text-red-600">오류 유형: ${errs}</p>
                  <p class="text-xs text-gray-500">키워드: ${c.keyword} (헷갈림: ${c.confusion})</p>
                  <hr class="border-red-100 my-2">
                  <p class="font-bold text-red-600">나의 논리</p><p>${c.myLogic}</p>
                  <p class="font-bold text-red-600 mt-2">정답 논리</p>
                  <p>① ${c.correctLogic?.split1||''}<br>② ${c.correctLogic?.split2||''}<br>③ ${c.correctLogic?.split3||''}</p>
                  <p class="font-bold text-red-600 mt-2">미스매치</p><p>${c.mismatch}</p>
                  <p class="font-bold text-red-600 mt-2">행동 강령</p><p>${c.action}</p>
                  ${linkBtn}
                </div>
              `;
            }

            
            const attCount = (Array.isArray(item.attachments) ? item.attachments.length : 0);
            if (attCount) {
              detailedContent += `
                <div class="mt-3 pt-3 border-t border-gray-200">
                  <button class="text-xs font-bold text-blue-600 hover:text-blue-800 underline" onclick="event.stopPropagation(); window.mgr?.openAttachments?.('${item.id}')">첨부 이미지 ${attCount}장 보기</button>
                </div>
              `;
            }

div.className = `accordion-card rounded-lg border ${borderColor} ${bgColor} hover:shadow-sm transition group`;
            div.innerHTML = `
              <div class="p-3 flex gap-3 items-start cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                <input type="checkbox" class="mt-1 history-checkbox" data-id="${item.id}" checked onclick="event.stopPropagation()">
                <div class="flex-1 min-w-0">
                  <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2">
                      ${typeBadge}
                      <span class="text-[10px] text-gray-400">${item.dateStr || ''} ${item.timeStr || ''}</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i data-lucide="chevron-down" class="chevron w-3 h-3 text-gray-400 transition-transform"></i>
                      <button class="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100" onclick="event.stopPropagation(); window.mgr.deleteSubmissionItem('${item.id}')"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                  </div>
                  <div class="text-sm text-gray-700 leading-snug break-words whitespace-pre-wrap">${summary}</div>
                </div>
              </div>
              <div class="accordion-body border-t p-3 text-xs text-gray-600 bg-white bg-opacity-50">
                ${detailedContent}
              </div>
            `;
            frag.appendChild(div);
          });
          list.appendChild(frag);
          safeCreateIcons();
        },

        // ===== Load Reports (Newest -> Oldest) =====
        loadReports: (studentName) => {
          if (!window.__firebaseOk || !window.db || !window.fs) return;
          if (reportUnsubscribe) reportUnsubscribe();
          const subRef = window.fs.collection(window.db, 'submissions');
          const q = window.fs.query(subRef, window.fs.where('studentName', '==', studentName));

          reportUnsubscribe = window.fs.onSnapshot(q, (snap) => {
            reportData = snap.docs.map(d => ({ id: d.id, ...d.data() }))
              .filter(d => d.type === 'ai_report')
              .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            window.mgr.renderReports();
          });
        },

        renderReports: () => {
          const list = $('mgr-report-list');
          if (!list) return;
          list.innerHTML = '';

          if (reportData.length === 0) {
            list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 rounded-xl bg-white bg-opacity-50 py-10"><p class="text-sm">생성된 리포트가 없습니다</p></div>`;
            return;
          }

          const frag = document.createDocumentFragment();
          reportData.forEach(item => {
            const rep = item.report || { learningContent: '', advancedDirection: '' };
            const div = document.createElement('div');
            div.className = "accordion-card bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden group transition-all hover:border-indigo-300";
            div.innerHTML = `
              <div class="p-4 flex justify-between items-center bg-gray-50 border-b border-gray-100 cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
                <div class="flex items-center gap-2">
                  <i data-lucide="chevron-down" class="chevron w-4 h-4 text-gray-400 transition-transform"></i>
                  <span class="text-xs font-bold text-gray-600">${item.dateStr} AI 리포트</span>
                </div>
                <button class="text-gray-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100 px-2" onclick="event.stopPropagation(); window.mgr.deleteSubmissionItem('${item.id}')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
              <div class="accordion-body p-5 bg-white">
                <div class="mb-4">
                  <h4 class="font-bold text-blue-700 mb-2 text-sm flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>학습 내용 & 복습 포인트</h4>
                  <p class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap pl-3 border-l-2 border-gray-100">${rep.learningContent || ''}</p>
                </div>
                <div>
                  <h4 class="font-bold text-purple-700 mb-2 text-sm flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>학생 성향 & 심화 학습 방향</h4>
                  <p class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap pl-3 border-l-2 border-gray-100">${rep.advancedDirection || ''}</p>
                </div>
              </div>
            `;
            frag.appendChild(div);
          });
          list.appendChild(frag);
          safeCreateIcons();
        },

        selectStudent: (id) => {
          selectedStudentId = id;
          const s = studentsData.find(x => x.id === id);
          if (!s) return;
          selectedStudentName = s.name;

          $('mgr-empty-state')?.classList.add('hidden');
          $('mgr-content')?.classList.remove('hidden');
          if ($('mgr-content')) $('mgr-content').style.display = 'flex';

          if ($('mgr-sel-name')) $('mgr-sel-name').innerText = s.name;
          if ($('mgr-sel-grade')) $('mgr-sel-grade').innerText = `(${s.grade})`;

          window.mgr.loadHistory(s.name);
          window.mgr.loadReports(s.name);

          safeCreateIcons();
        },

        addMemo: async () => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);
          if (!selectedStudentId || !selectedStudentName) return;
          const inp = $('mgr-memo-input');
          const val = (inp?.value || '').trim();
          if (!val) return;

          await window.fs.addDoc(window.fs.collection(window.db, 'submissions'), {
            type: 'memo',
            studentName: selectedStudentName,
            content: val,
            dateStr: new Date().toLocaleDateString(),
            timestamp: window.fs.serverTimestamp()
          });
          inp.value = '';
        },

        openReportModal: () => {
          if (!selectedStudentId) return;

          // capture target
          window.mgr._reportTargetId = selectedStudentId;
          window.mgr._reportTargetName = selectedStudentName;

          const checks = document.querySelectorAll('.history-checkbox:checked');
          if (checks.length === 0) return showToast("선택된 기록이 없습니다.");

          const selectedItems = [];
          checks.forEach(chk => {
            const item = historyData.find(h => h.id === chk.dataset.id);
            if (item) selectedItems.push(item);
          });

          // ensure oldest -> newest
          selectedItems.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

          window.mgr._currentSelectedItems = selectedItems;

          $('prompt-context-view').innerHTML = generateAccordionHTML(selectedItems);
          setTimeout(safeCreateIcons, 50);

          $('prompt-editor').value = DEFAULT_INSTRUCTION;
          $('prompt-modal').classList.remove('hidden');
        },

        executeReport: async () => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);

          const targetId = window.mgr._reportTargetId;
          const targetName = window.mgr._reportTargetName;
          if (!targetId || !targetName) return showToast("학생 정보 오류");

          const items = window.mgr._currentSelectedItems || [];
          const contextText = generateFullContext(items);

          const instructions = $('prompt-editor').value;
          const fullPrompt = `${SYSTEM_PROMPT}\n\n[선택된 학습 기록 (전체 데이터)]\n${contextText}\n\n[지침]\n${instructions}${REPORT_PROMPT_SUFFIX}`;

          $('prompt-modal').classList.add('hidden');
          showToast("리포트 생성 중...");
          try {
            const json = await callGeminiSecure(fullPrompt, true);
            if (json) {
              await window.fs.addDoc(window.fs.collection(window.db, 'submissions'), {
                type: 'ai_report',
                studentName: targetName,
                report: json,
                dateStr: new Date().toLocaleDateString(),
                timestamp: window.fs.serverTimestamp()
              });
              showToast("완료");
            }
          } catch (e) {
            console.error(e);
            showToast("실패: " + (e?.message || ''));
          }
        },

        openEditStudent: () => {
          if (!selectedStudentId) return;
          const s = studentsData.find(x => x.id === selectedStudentId);
          if (!s) return;
          $('edit-std-name').value = s.name;
          $('edit-std-grade').value = s.grade;
          $('student-edit-modal').classList.remove('hidden');
        },

        saveStudentInfo: async () => {
          if (!window.__firebaseOk || !window.db || !window.fs) return showToast("Firebase 연결 필요", 2400);
          if (!selectedStudentId) return;
          const newName = ($('edit-std-name').value || '').trim();
          const newGrade = ($('edit-std-grade').value || '').trim();
          if (!newName) return showToast("이름 필수");

          await window.fs.updateDoc(window.fs.doc(window.db, ...APP_DOC_PATH, selectedStudentId), {
            name: newName, grade: newGrade
          });

          $('student-edit-modal').classList.add('hidden');
          showToast("수정 완료");
        }
      };

      // =========================
      // Init
      // =========================
      renderConfusionScale();
      renderErrorGrid();
      if ($('w_date_display')) $('w_date_display').innerText = new Date().toLocaleDateString();
      safeCreateIcons();

      // Default route
      window.router('landing');
    });
  </script>
</body>
</html>